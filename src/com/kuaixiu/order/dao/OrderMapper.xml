<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kuaixiu.order.dao.OrderMapper">
    <!-- Result Map-->
    <resultMap id="BaseResultMap" type="com.kuaixiu.order.entity.Order">
        <result column="id" property="id"/>
        <result column="order_no" property="orderNo"/>
        <result column="customer_id" property="customerId"/>
        <result column="customer_name" property="customerName"/>
        <result column="provider_code" property="providerCode"/>
        <result column="provider_name" property="providerName"/>
        <result column="shop_code" property="shopCode"/>
        <result column="shop_name" property="shopName"/>
        <result column="brand_id" property="brandId"/>
        <result column="brand_name" property="brandName"/>
        <result column="model_id" property="modelId"/>
        <result column="model_name" property="modelName"/>
        <result column="color" property="color"/>
        <result column="repair_type" property="repairType"/>
        <result column="order_price" property="orderPrice"/>
        <result column="real_price" property="realPrice"/>
        <result column="is_update_price" property="isUpdatePrice"/>
        <result column="is_use_coupon" property="isUseCoupon"/>
        <result column="coupon_id" property="couponId"/>
        <result column="coupon_code" property="couponCode"/>
        <result column="coupon_name" property="couponName"/>
        <result column="coupon_type" property="couponType"/>
        <result column="coupon_price" property="couponPrice"/>
        <result column="is_drawback" property="isDrawback"/>
        <result column="drawback_price" property="drawbackPrice"/>
        <result column="drawback_time" property="drawbackTime"/>
        <result column="order_status" property="orderStatus"/>
        <result column="cancel_type" property="cancelType"/>
        <result column="cancel_status" property="cancelStatus"/>
        <result column="from_system" property="fromSystem"/>
        <result column="from_system_name" property="fromSystemName"/>
        <result column="is_deposit" property="isDeposit"/>
        <result column="deposit_type" property="depositType"/>
        <result column="deposit_price" property="depositPrice"/>
        <result column="deposit_time" property="depositTime"/>
        <result column="pay_type" property="payType"/>
        <result column="pay_status" property="payStatus"/>
        <result column="pay_time" property="payTime"/>
        <result column="pay_price" property="payPrice"/>
        <result column="agreed_time" property="agreedTime"/>
        <result column="is_dispatch" property="isDispatch"/>
        <result column="dispatch_time" property="dispatchTime"/>
        <result column="engineer_id" property="engineerId"/>
        <result column="engineer_number" property="engineerNumber"/>
        <result column="engineer_name" property="engineerName"/>
        <result column="engineer_mobile" property="engineerMobile"/>
        <result column="start_check_time" property="startCheckTime"/>
        <result column="end_check_time" property="endCheckTime"/>
        <result column="start_repair_time" property="startRepairTime"/>
        <result column="end_repair_time" property="endRepairTime"/>
        <result column="mobile" property="mobile"/>
        <result column="email" property="email"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
        <result column="province" property="province"/>
        <result column="city" property="city"/>
        <result column="county" property="county"/>
        <result column="street" property="street"/>
        <result column="areas" property="areas"/>
        <result column="address" property="address"/>
        <result column="postscript" property="postscript"/>
        <result column="note" property="note"/>
        <result column="eng_note" property="engNote"/>
        <result column="is_mobile" property="isMobile"/>
        <result column="sort" property="sort"/>
        <result column="is_comment" property="isComment"/>
        <result column="balance_status" property="balanceStatus"/>
        <result column="balance_time" property="balanceTime"/>
        <result column="balance_no" property="balanceNo"/>
        <result column="is_lock" property="isLock"/>
        <result column="is_del" property="isDel"/>
        <result column="in_time" property="inTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="update_userid" property="updateUserid"/>
        <result column="end_time" property="endTime"/>
        <result column="clerk_id" property="clerkId"/>
        <result column="is_show" property="isShow"/>
        <result column="cancel_reason" property="cancelReason"/>
        <result column="send_agreed_news" property="sendAgreedNews"/>
        <result column="isRework" property="isRework"/>
        <result column="order_type" property="orderType"/>
        <association property="shop" column="shop_code" resultMap="ShopMap"></association>
    </resultMap>

    <resultMap id="ShopMap" type="com.kuaixiu.shop.entity.Shop">
        <result column="shop_id" property="id"/>
        <result column="provider_code" property="providerCode"/>
        <result column="provider_name" property="providerName"/>
        <result column="shop_code" property="code"/>
        <result column="shop_name" property="name"/>
        <result column="shop_manager_name" property="managerName"/>
        <result column="shop_manager_mobile" property="managerMobile"/>
        <result column="shop_tel" property="tel"/>
        <result column="shop_email" property="email"/>
        <result column="shop_areas" property="areas"/>
        <result column="shop_address" property="address"/>
    </resultMap>

    <!-- kx_order table all fields -->
    <sql id="Base_Column_List">
        t.id,t.order_no,t.customer_id,t.customer_name,t.provider_code,t.provider_name
        ,t.shop_code,t.shop_name,t.brand_id,t.brand_name,t.model_id,t.model_name,t.color
        ,t.repair_type,t.order_price,t.real_price,t.is_update_price,t.is_drawback,t.drawback_price
        ,date_format(t.`drawback_time`,'%Y-%m-%d %H:%i:%s')drawback_time
        ,t.order_status,t.cancel_type,t.cancel_status,t.is_deposit,t.deposit_type,t.deposit_price
        ,date_format(t.`deposit_time`,'%Y-%m-%d %H:%i:%s')deposit_time,t.pay_type
        ,t.pay_status,date_format(t.`pay_time`,'%Y-%m-%d %H:%i:%s')pay_time,t.pay_price
        ,t.is_dispatch,date_format(t.`dispatch_time`,'%Y-%m-%d %H:%i:%s')dispatch_time
        ,t.engineer_id,t.engineer_number,t.engineer_name,t.engineer_mobile
        ,date_format(t.`start_check_time`,'%Y-%m-%d %H:%i:%s')start_check_time
        ,date_format(t.`end_check_time`,'%Y-%m-%d %H:%i:%s')end_check_time
        ,date_format(t.`start_repair_time`,'%Y-%m-%d %H:%i:%s')start_repair_time
        ,date_format(t.`end_repair_time`,'%Y-%m-%d %H:%i:%s')end_repair_time
        ,t.mobile,t.email,t.longitude,t.latitude,t.province,t.city,t.county,t.street
        ,t.areas,t.address,t.postscript,t.note,t.is_mobile,t.sort,t.is_comment,t.balance_status
        ,date_format(t.`balance_time`,'%Y-%m-%d %H:%i:%s')balance_time,t.balance_no
        ,t.is_lock,t.is_del,date_format(t.`in_time`,'%Y-%m-%d %H:%i:%s')in_time
        ,date_format(t.`update_time`,'%Y-%m-%d %H:%i:%s')update_time,t.update_userid
        ,date_format(t.`end_time`,'%Y-%m-%d %H:%i:%s')end_time
        ,t.is_use_coupon,t.coupon_id,t.coupon_code,t.coupon_name,t.coupon_type,t.coupon_price
        ,t.from_system,t.agreed_time,t.clerk_id,t.is_show ,t.send_agreed_news,t.cancel_reason
        ,eng_note
    </sql>

    <!-- 根据id查询  -->
    <select id="queryByIdFromUpdatePrice" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        from kx_order t
        where t.id = #{id}
    </select>

    <!-- 插入记录 -->
    <insert id="add" parameterType="Object">
        insert into kx_order
        (id,order_no,customer_id,customer_name,provider_code,provider_name
        ,shop_code,shop_name,brand_id,brand_name,model_id,model_name,color
        ,repair_type,order_price,real_price,order_status,is_deposit
        ,deposit_type,deposit_price,deposit_time,mobile,email,longitude
        ,latitude,province,city,county,street,areas,address
        ,postscript,note,is_mobile,sort,is_lock,is_del,in_time
        ,is_use_coupon,coupon_id,coupon_code,coupon_name,coupon_type
        ,coupon_price,from_system,clerk_id,send_agreed_news,eng_note
        <if test="engineerId!=null and engineerId!=''">
            ,engineer_id
        </if>
        <if test="engineerNumber!=null and engineerNumber!=''">
            ,engineer_number
        </if>
        <if test="engineerName!=null and engineerName!=''">
            ,engineer_name
        </if>
        <if test="engineerMobile!=null and engineerMobile!=''">
            ,engineer_mobile
        </if>
        <if test="isDispatch!=null and isDispatch!=''">
            ,is_dispatch
        </if>
        <if test="dispatchTime!=null and dispatchTime!=''">
            ,dispatch_time
        </if>
        )
        values
        (#{id},#{orderNo},#{customerId},#{customerName},#{providerCode},#{providerName}
        ,#{shopCode},#{shopName},#{brandId},#{brandName},#{modelId},#{modelName},#{color}
        ,#{repairType},#{orderPrice},#{realPrice},#{orderStatus},#{isDeposit}
        ,#{depositType},#{depositPrice},#{depositTime},#{mobile},#{email},#{longitude}
        ,#{latitude},#{province},#{city},#{county},#{street},#{areas},#{address}
        ,#{postscript},#{note},#{isMobile},#{sort},#{isLock},#{isDel},now()
        ,#{isUseCoupon},#{couponId},#{couponCode},#{couponName},#{couponType}
        ,#{couponPrice},#{fromSystem},#{clerkId},#{sendAgreedNews},#{engNote}
        <if test="engineerId!=null and engineerId!=''">
            ,#{engineerId}
        </if>
        <if test="engineerNumber!=null and engineerNumber!=''">
            ,#{engineerNumber}
        </if>
        <if test="engineerName!=null and engineerName!=''">
            ,#{engineerName}
        </if>
        <if test="engineerMobile!=null and engineerMobile!=''">
            ,#{engineerMobile}
        </if>
        <if test="isDispatch!=null and isDispatch!=''">
            ,#{isDispatch}
        </if>
        <if test="dispatchTime!=null and dispatchTime!=''">
            ,#{dispatchTime}
        </if>)
    </insert>

    <!-- 根据id，修改记录-->
    <update id="update" parameterType="Object">
        update kx_order 
        set 
            customer_id=#{customerId},
            customer_name=#{customerName},
            provider_code=#{providerCode},
            provider_name=#{providerName},
            shop_code=#{shopCode},
            shop_name=#{shopName},
            brand_id=#{brandId},
            brand_name=#{brandName},
            model_id=#{modelId},
            model_name=#{modelName},
            order_price=#{orderPrice},
            real_price=#{realPrice},
            is_update_price=#{isUpdatePrice},
            is_drawback=#{isDrawback},
            drawback_price=#{drawbackPrice},
            drawback_time=#{drawbackTime},
            order_status=#{orderStatus},
            cancel_type=#{cancelType},
            cancel_status=#{cancelStatus},
            is_deposit=#{isDeposit},
            deposit_type=#{depositType},
            deposit_price=#{depositPrice},
            deposit_time=#{depositTime},
            pay_type=#{payType},
            pay_status=#{payStatus},
            pay_time=#{payTime},
            pay_price=#{payPrice},
            agreed_time=#{agreedTime},
            is_dispatch=#{isDispatch},
            dispatch_time=#{dispatchTime},
            engineer_id=#{engineerId},
            engineer_number=#{engineerNumber},
            engineer_name=#{engineerName},
            engineer_mobile=#{engineerMobile},
            start_check_time=#{startCheckTime},
            end_check_time=#{endCheckTime},
            start_repair_time=#{startRepairTime},
            end_repair_time=#{endRepairTime},
            mobile=#{mobile},
            email=#{email},
            longitude=#{longitude},
            latitude=#{latitude},
            province=#{province},
            city=#{city},
            county=#{county},
            street=#{street},
            areas=#{areas},
            address=#{address},
            postscript=#{postscript},
            note=#{note},
            eng_note=#{engNote},
            is_mobile=#{isMobile},
            sort=#{sort},
            is_comment=#{isComment},
            balance_status=#{balanceStatus},
            balance_time=#{balanceTime},
            balance_no=#{balanceNo},
            is_lock=#{isLock},
            is_del=#{isDel},
            update_time=now(),
            update_userid=#{updateUserid},
            end_time=#{endTime},
            send_agreed_news=#{sendAgreedNews},
            cancel_reason=#{cancelReason}
        where id=#{id}
    </update>

    <!-- 删除记录 -->
    <delete id="delete" parameterType="Object">
        delete from kx_order where id = #{id}
    </delete>

    <!-- 根据id查询  -->
    <select id="queryById" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        ,s.id shop_id,s.manager_name shop_manager_name, s.manager_mobile shop_manager_mobile
        ,s.tel shop_tel, s.email shop_email, s.areas shop_areas, s.address shop_address
        ,fs.name from_system_name
        from kx_order t
        left join kx_shop s on t.shop_code = s.code
        left join kx_from_system fs on t.from_system = fs.id
        where t.id = #{id}
    </select>

    <!-- 根据订单号查询  -->
    <select id="queryByOrderNo" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        ,s.id shop_id,s.manager_name shop_manager_name, s.manager_mobile shop_manager_mobile
        ,s.tel shop_tel, s.email shop_email, s.areas shop_areas, s.address shop_address
        ,fs.name from_system_name
        from kx_order t
        left join kx_shop s on t.shop_code = s.code
        left join kx_from_system fs on t.from_system = fs.id
        where t.order_no = #{orderNo}
    </select>

    <!-- 统计工程师本月订单数 -->
    <select id="queryStatisticByEngineer" resultMap="BaseResultMap" parameterType="Object">
        select count(t.id) sort, t.end_time
        from kx_order t
        where 1=1
        and t.order_status = 50
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and t.dispatch_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and t.end_time &lt;= #{queryEndTime}
        </if>
        group by left(t.end_time, 10) order by t.end_time
    </select>

    <!-- 查询列表无分页 -->
    <select id="queryCount" resultType="Integer" parameterType="Object">
        select count(id) from kx_order
        where 1=1
        <if test="orderNo != null and orderNo != ''">
            and order_no = #{orderNo}
        </if>
        <if test="isUpdatePrice != null and isUpdatePrice != ''">
            and is_update_price = #{isUpdatePrice}
        </if>
        <if test="customerId != null and customerId != ''">
            and customer_id = #{customerId}
        </if>
        <if test="customerName != null and customerName != ''">
            and customer_name = #{customerName}
        </if>
        <if test="providerCode != null and providerCode != ''">
            and provider_code = #{providerCode}
        </if>
        <if test="providerName != null and providerName != ''">
            and provider_name = #{providerName}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and shop_code = #{shopCode}
        </if>
        <if test="brandId != null and brandId != ''">
            and brand_id = #{brandId}
        </if>
        <if test="modelId != null and modelId != ''">
            and model_id = #{modelId}
        </if>
        <if test="repairType != null ">
            and repair_type = #{repairType}
        </if>
        <if test="orderStatus != null and orderStatus != ''">
            and order_status = #{orderStatus}
        </if>
        <if test="isDeposit != null">
            and is_deposit = #{isDeposit}
        </if>
        <if test="payType != null and payType != ''">
            and pay_type = #{payType}
        </if>
        <if test="payStatus != null">
            and pay_status = #{payStatus}
        </if>
        <if test="isDispatch != null and isDispatch != ''">
            and is_dispatch = #{isDispatch}
        </if>
        <if test="engineerId != null and engineerId != ''">
            and engineer_id = #{engineerId}
        </if>
        <if test="engineerNumber != null and engineerNumber != ''">
            and engineer_number = #{engineerNumber}
        </if>
        <if test="mobile != null and mobile != ''">
            and mobile = #{mobile}
        </if>
        <if test="note != null and note != ''">
            and note = #{note}
        </if>
        <if test="isMobile != null and isMobile != ''">
            and is_mobile = #{isMobile}
        </if>
        <if test="balanceStatus != null and balanceStatus != ''">
            and balance_status = #{balanceStatus}
        </if>
        <if test="balanceNo != null and balanceNo != ''">
            and balance_no = #{balanceNo}
        </if>
        <if test="isLock != null">
            and is_lock = #{isLock}
        </if>
        <if test="isDel != null">
            and is_del = #{isDel}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and in_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and in_time &lt;= #{queryEndTime}
        </if>
    </select>

    <!-- 查询列表无分页 -->
    <select id="queryAmount" resultType="java.math.BigDecimal" parameterType="Object">
        select IFNULL(sum(real_price),0) from kx_order
        where 1=1
        <if test="orderNo != null and orderNo != ''">
            and order_no = #{orderNo}
        </if>
        <if test="isUpdatePrice != null and isUpdatePrice != ''">
            and is_update_price = #{isUpdatePrice}
        </if>
        <if test="customerId != null and customerId != ''">
            and customer_id = #{customerId}
        </if>
        <if test="customerName != null and customerName != ''">
            and customer_name = #{customerName}
        </if>
        <if test="providerCode != null and providerCode != ''">
            and provider_code = #{providerCode}
        </if>
        <if test="providerName != null and providerName != ''">
            and provider_name = #{providerName}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and shop_code = #{shopCode}
        </if>
        <if test="brandId != null and brandId != ''">
            and brand_id = #{brandId}
        </if>
        <if test="modelId != null and modelId != ''">
            and model_id = #{modelId}
        </if>
        <if test="repairType != null">
            and repair_type = #{repairType}
        </if>
        <if test="orderStatus != null and orderStatus != ''">
            and order_status = #{orderStatus}
        </if>
        <if test="isDeposit != null">
            and is_deposit = #{isDeposit}
        </if>
        <if test="payType != null and payType != ''">
            and pay_type = #{payType}
        </if>
        <if test="payStatus != null">
            and pay_status = #{payStatus}
        </if>
        <if test="isDispatch != null and isDispatch != ''">
            and is_dispatch = #{isDispatch}
        </if>
        <if test="engineerId != null and engineerId != ''">
            and engineer_id = #{engineerId}
        </if>
        <if test="engineerNumber != null and engineerNumber != ''">
            and engineer_number = #{engineerNumber}
        </if>
        <if test="mobile != null and mobile != ''">
            and mobile = #{mobile}
        </if>
        <if test="note != null and note != ''">
            and note = #{note}
        </if>
        <if test="isMobile != null and isMobile != ''">
            and is_mobile = #{isMobile}
        </if>
        <if test="balanceStatus != null and balanceStatus != ''">
            and balance_status = #{balanceStatus}
        </if>
        <if test="balanceNo != null and balanceNo != ''">
            and balance_no = #{balanceNo}
        </if>
        <if test="isLock != null">
            and is_lock = #{isLock}
        </if>
        <if test="isDel != null">
            and is_del = #{isDel}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and in_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and in_time &lt;= #{queryEndTime}
        </if>
    </select>

    <!-- 查询列表无分页 -->
    <select id="queryList" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        ,s.id shop_id,s.manager_name shop_manager_name, s.manager_mobile shop_manager_mobile
        ,s.tel shop_tel, s.email shop_email, s.areas shop_areas, s.address shop_address
        ,fs.name from_system_name
        from kx_order t
        left join kx_shop s on t.shop_code = s.code
        left join kx_from_system fs on t.from_system = fs.id
        where 1=1
        <if test="isPatch == 1 and isPatch != ''">
            and order_no in
            (select order_no from kx_order_detail d
            where 1=1
            AND d.project_name NOT LIKE CONCAT('%','贴膜','%')
            )
        </if>
        <if test="id != null and id != ''">
            and t.id = #{id}
        </if>
        <if test="isUpdatePrice != null and isUpdatePrice != ''">
            and is_update_price = #{isUpdatePrice}
        </if>
        <if test="orderNo != null and orderNo != ''">
            and t.order_no like CONCAT('%', #{orderNo}, '%')
        </if>
        <if test="customerId != null and customerId != ''">
            and t.customer_id = #{customerId}
        </if>
        <if test="customerName != null and customerName != ''">
            and t.customer_name = #{customerName}
        </if>
        <if test="providerCode != null and providerCode != ''">
            and t.provider_code = #{providerCode}
        </if>
        <if test="providerName != null and providerName != ''">
            and t.provider_name = #{providerName}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and t.shop_code like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="shopName != null and shopName != ''">
            and t.shop_name like CONCAT('%', #{shopName}, '%')
        </if>
        <if test="shopManagerMobile != null and shopManagerMobile != ''">
            and t.shop_code in (select code from kx_shop s where s.manager_mobile like CONCAT('%', #{shopManagerMobile},
            '%') and s.is_del = 0 )
        </if>
        <if test="brandId != null and brandId != ''">
            and t.brand_id = #{brandId}
        </if>
        <if test="brandName != null and brandName != ''">
            and t.brand_name like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="modelId != null and modelId != ''">
            and t.model_id = #{modelId}
        </if>
        <if test="modelName != null and modelName != ''">
            and t.model_name like CONCAT('%', #{modelName}, '%')
        </if>

        <if test="orderStatus != null and orderStatus != ''">
            and t.order_status = #{orderStatus}
        </if>

        <if test="queryStatusArray != null and queryStatusArray.size() > 0">
            and t.order_status in
            <foreach collection="queryStatusArray" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>

        <if test="queryIds != null and queryIds.size() > 0">
            and t.id in
            <foreach collection="queryIds" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="isDispatch != null">
            and t.is_dispatch = #{isDispatch}
        </if>
        <if test="dispatchTime != null and dispatchTime != ''">
            and t.dispatch_time &lt; #{dispatchTime}
        </if>
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>
        <if test="engineerName != null and engineerName != ''">
            and t.engineer_name like CONCAT('%', #{engineerName}, '%')
        </if>
        <if test="engineerNumber != null and engineerNumber != ''">
            and t.engineer_number like CONCAT('%', #{engineerNumber}, '%')
        </if>
        <if test="mobile != null and mobile != ''">
            and t.mobile like CONCAT('%', #{mobile}, '%')
        </if>
        <if test="province != null and province != ''">
            and t.province = #{province}
        </if>
        <if test="city != null and city != ''">
            and t.city = #{city}
        </if>
        <if test="county != null and county != ''">
            and t.county = #{county}
        </if>
        <if test="balanceStatus != null">
            and t.balance_status = #{balanceStatus}
        </if>
        <if test="balanceNo != null and balanceNo != ''">
            and t.balance_no = #{balanceNo}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and t.in_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and t.in_time &lt;= #{queryEndTime}
        </if>
        <if test="queryRepairStartTime != null and queryRepairStartTime != ''">
            and t.end_time &gt;= #{queryRepairStartTime}
        </if>
        <if test="queryRepairEndTime != null and queryRepairEndTime != ''">
            and t.end_time &lt;= #{queryRepairEndTime}
        </if>
        <if test="isDel != null">
            and t.is_del = #{isDel}
        </if>
        <if test="clerkId != null and clerkId != ''">
            and t.clerk_id = #{clerkId}
        </if>
        <if test="isShow !=null">
            and t.is_show=#{isShow}
        </if>
        <if test="sendAgreedNews != null ">
            and t.send_agreed_news = #{sendAgreedNews}
        </if>
        <if test="inTime != null and inTime != ''">
            and t.in_time &lt; #{inTime}
        </if>
        <if test="fromSystem != null and fromSystem != ''">
            and t.from_system = #{fromSystem}
        </if>
        <if test="repairType != null ">
            and t.repair_type = #{repairType}
        </if>
        order by t.in_time desc
    </select>

    <!-- 查询列表无分页 -->
    <select id="queryListApiForPage" resultMap="BaseResultMap" parameterType="Object">
        select t.id,t.order_no,t.customer_id,t.customer_name
        ,t.brand_id,t.brand_name,t.model_id,t.model_name,t.color
        ,t.repair_type,t.order_price,t.real_price
        ,t.order_status,t.cancel_type,t.cancel_status
        ,t.pay_type
        ,t.pay_status,date_format(t.`pay_time`,'%Y-%m-%d %H:%i:%s')pay_time,t.pay_price
        ,t.engineer_id
        ,t.mobile
        ,t.balance_status
        ,date_format(t.`in_time`,'%Y-%m-%d %H:%i:%s')in_time
        ,date_format(t.`update_time`,'%Y-%m-%d %H:%i:%s')update_time
        ,t.is_use_coupon,t.coupon_id,t.coupon_code,t.coupon_name,t.coupon_type,t.coupon_price
        ,t.agreed_time,t.eng_note,t.isRework,t.isUpdatePrice,t.orderType
        ,t.is_comment,t.shop_name
        from
        (
        select t1.id id,t1.order_no order_no,t1.customer_id customer_id,t1.customer_name customer_name
        ,t1.brand_id brand_id,t1.brand_name brand_name,t1.model_id model_id,t1.model_name model_name,t1.color color
        ,t1.repair_type repair_type,t1.order_price order_price,t1.real_price real_price
        ,t1.order_status order_status,t1.cancel_type cancel_type,t1.cancel_status cancel_status
        ,t1.pay_type pay_type
        ,t1.pay_status pay_status,date_format(t1.`pay_time`,'%Y-%m-%d %H:%i:%s')pay_time,t1.pay_price pay_price
        ,t1.engineer_id engineer_id
        ,t1.mobile mobile
        ,t1.balance_status balance_status
        ,date_format(t1.`in_time`,'%Y-%m-%d %H:%i:%s')in_time
        ,date_format(t1.`update_time`,'%Y-%m-%d %H:%i:%s')update_time
        ,t1.is_use_coupon is_use_coupon,t1.coupon_id coupon_id,t1.coupon_code coupon_code
        ,t1.coupon_name coupon_name,t1.coupon_type coupon_type,t1.coupon_price coupon_price
        ,t1.agreed_time agreed_time,t1.eng_note eng_note,0 isRework,t1.is_update_price is_update_price
        ,1 order_type,t1.is_comment is_comment,t1.shop_name shop_name
        from kx_order t1
        UNION ALL
        select t2.id,t2.order_rework_no order_no,t3.customer_id,t3.customer_name
        ,t3.brand_id,t3.brand_name,t3.model_id,t3.model_name,t3.color
        ,null repair_type,t2.order_price,t2.real_price
        ,t2.order_status,t2.cancel_type,t2.cancel_status
        ,null pay_type
        ,null pay_status,null pay_time,null pay_price
        ,t2.engineer_id
        ,t3.mobile
        ,null balance_status
        ,date_format(t2.`in_time`,'%Y-%m-%d %H:%i:%s')in_time
        ,date_format(t2.`update_time`,'%Y-%m-%d %H:%i:%s')update_time
        ,null is_use_coupon,null coupon_id,null coupon_code,null coupon_name,null coupon_type,null coupon_price
        ,t2.agreed_time,t2.eng_note,1 isRework,0 is_update_price,1 order_type,t2.is_comment is_comment
        ,t2.shop_name shop_name
        from kx_rework_order t2 LEFT JOIN kx_order t3 ON t2.parent_order=t3.order_no
        )t
        where 1=1
        <if test="queryStatusArray != null and queryStatusArray.size() > 0">
            and t.order_status in
            <foreach collection="queryStatusArray" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>
        order by t.in_time desc
    </select>

    <!-- 查询列表 带分页 -->
    <select id="queryListForPage" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        ,s.id shop_id,s.manager_name shop_manager_name, s.manager_mobile shop_manager_mobile
        ,s.tel shop_tel, s.email shop_email, s.areas shop_areas, s.address shop_address
        ,fs.name from_system_name
        from kx_order t
        left join kx_shop s on t.shop_code = s.code
        left join kx_from_system fs on t.from_system = fs.id
        where 1=1
        <if test="isPatch == 1 and isPatch != ''">
            and order_no in
            (select order_no from kx_order_detail d
            where 1=1
            AND d.project_name NOT LIKE CONCAT('%','贴膜','%')
            )
        </if>
        <if test="id != null and id != ''">
            and t.id = #{id}
        </if>
        <if test="orderNo != null and orderNo != ''">
            and t.order_no like CONCAT('%', #{orderNo}, '%')
        </if>
        <if test="isUpdatePrice != null and isUpdatePrice != ''">
            and is_update_price = #{isUpdatePrice}
        </if>
        <if test="customerId != null and customerId != ''">
            and t.customer_id = #{customerId}
        </if>
        <if test="customerName != null and customerName != ''">
            and t.customer_name = #{customerName}
        </if>
        <if test="providerCode != null and providerCode != ''">
            and t.provider_code = #{providerCode}
        </if>
        <if test="providerName != null and providerName != ''">
            and t.provider_name = #{providerName}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and t.shop_code like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="shopName != null and shopName != ''">
            and t.shop_name like CONCAT('%', #{shopName}, '%')
        </if>
        <if test="shopManagerMobile != null and shopManagerMobile != ''">
            and t.shop_code in (select code from kx_shop s where s.manager_mobile like CONCAT('%', #{shopManagerMobile},
            '%') and s.is_del = 0 )
        </if>
        <if test="brandId != null and brandId != ''">
            and t.brand_id = #{brandId}
        </if>
        <if test="brandName != null and brandName != ''">
            and t.brand_name like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="modelId != null and modelId != ''">
            and t.model_id = #{modelId}
        </if>
        <if test="modelName != null and modelName != ''">
            and t.model_name like CONCAT('%', #{modelName}, '%')
        </if>

        <if test="orderStatus != null and orderStatus != ''">
            and t.order_status = #{orderStatus}
        </if>

        <if test="queryStatusArray != null and queryStatusArray.size() > 0">
            and t.order_status in
            <foreach collection="queryStatusArray" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="isDispatch != null">
            and t.is_dispatch = #{isDispatch}
        </if>
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>

        <if test="engineerNumber != null and engineerNumber != ''">
            and t.engineer_number like CONCAT('%', #{engineerNumber}, '%')
        </if>
        <if test="engineerName != null and engineerName != ''">
            and t.engineer_name like CONCAT('%', #{engineerName}, '%')
        </if>
        <if test="mobile != null and mobile != ''">
            and t.mobile like CONCAT('%', #{mobile}, '%')
        </if>
        <if test="province != null and province != ''">
            and t.province = #{province}
        </if>
        <if test="city != null and city != ''">
            and t.city = #{city}
        </if>
        <if test="county != null and county != ''">
            and t.county = #{county}
        </if>
        <if test="balanceStatus != null">
            and t.balance_status = #{balanceStatus}
        </if>
        <if test="balanceNo != null and balanceNo != ''">
            and t.balance_no = #{balanceNo}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and t.in_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and t.in_time &lt;= #{queryEndTime}
        </if>
        <if test="queryRepairStartTime != null and queryRepairStartTime != ''">
            and t.end_time &gt;= #{queryRepairStartTime}
        </if>
        <if test="queryRepairEndTime != null and queryRepairEndTime != ''">
            and t.end_time &lt;= #{queryRepairEndTime}
        </if>
        <if test="isDel != null">
            and t.is_del = #{isDel}
        </if>
        <if test="isShow !=null">
            and t.is_show=#{isShow}
        </if>
        <if test="clerkId != null and clerkId != ''">
            and t.clerk_id = #{clerkId}
        </if>
        <if test="repairType != null ">
            and t.repair_type = #{repairType}
        </if>
        <if test="isComment != null ">
            and t.is_Comment = #{isComment}
        </if>
        <if test="fromSystem != null and fromSystem != ''">
            and t.from_system = #{fromSystem}
        </if>
        <if test="fromSystemName != null and fromSystemName != ''">
            and fs.name = #{fromSystemName}
        </if>
        <if test="orderBy != null and orderBy !=''">
            order by ${orderBy}
        </if>
        <if test="orderBy == null or orderBy ==''">
            order by t.in_time desc
        </if>
    </select>

    <!-- 查询列表 -->
    <select id="queryListMap" resultType="Map" parameterType="Object">
        select
        t.id,t.order_no,t.customer_id,t.customer_name,t.provider_code,t.provider_name
        ,t.shop_code,t.shop_name,t.brand_id,t.brand_name,t.model_id,t.model_name,t.color
        ,t.repair_type,t.order_price,t.real_price,t.order_status,t.balance_status
        ,date_format(t.`deposit_time`,'%Y-%m-%d %H:%i:%s')deposit_time
        ,date_format(t.`dispatch_time`,'%Y-%m-%d %H:%i:%s')dispatch_time
        ,t.engineer_id,t.engineer_number,t.engineer_name,t.engineer_mobile
        ,t.mobile,t.areas,t.address,date_format(t.`in_time`,'%Y-%m-%d %H:%i:%s')in_time
        ,s.tel shop_tel,s.manager_mobile shop_manager_mobile,s.manager_name shop_manager_name
        ,t.is_use_coupon,t.coupon_id,t.coupon_code,t.coupon_name,t.coupon_type,t.coupon_price
        ,t.from_system
        <if test="orderStatus == 2">
            ,(select count(1) from kx_engineer e where e.is_del = 0 and e.is_dispatch = 0 and e.shop_code = t.shop_code
            ) eng_count
        </if>
        ,fs.name from_system_name
        from kx_order t
        left join kx_shop s on t.shop_code = s.`code`
        left join kx_from_system fs on t.from_system = fs.id
        where 1=1
        <if test="orderNo != null and orderNo != ''">
            and t.order_no like CONCAT('%', #{orderNo}, '%')
        </if>
        <if test="customerId != null and customerId != ''">
            and t.customer_id = #{customerId}
        </if>
        <if test="customerName != null and customerName != ''">
            and t.customer_name = #{customerName}
        </if>
        <if test="providerCode != null and providerCode != ''">
            and t.provider_code = #{providerCode}
        </if>
        <if test="providerName != null and providerName != ''">
            and t.provider_name = #{providerName}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and t.shop_code like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="shopName != null and shopName != ''">
            and t.shop_name like CONCAT('%', #{shopName}, '%')
        </if>
        <if test="brandId != null and brandId != ''">
            and t.brand_id = #{brandId}
        </if>
        <if test="isUpdatePrice != null and isUpdatePrice != ''">
            and is_update_price = #{isUpdatePrice}
        </if>
        <if test="brandName != null and brandName != ''">
            and t.brand_name like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="modelId != null and modelId != ''">
            and t.model_id = #{modelId}
        </if>
        <if test="modelName != null and modelName != ''">
            and t.model_name like CONCAT('%', #{modelName}, '%')
        </if>

        <if test="orderStatus != null and orderStatus != ''">
            and t.order_status = #{orderStatus}
        </if>

        <if test="queryStatusArray != null and queryStatusArray.size() > 0">
            and t.order_status in
            <foreach collection="queryStatusArray" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="queryIds != null and queryIds.size() > 0">
            and t.id in
            <foreach collection="queryIds" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="isDispatch != null">
            and is_dispatch = #{isDispatch}
        </if>
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>

        <if test="engineerNumber != null and engineerNumber != ''">
            and t.engineer_number like CONCAT('%', #{engineerNumber}, '%')
        </if>
        <if test="mobile != null and mobile != ''">
            and t.mobile like CONCAT('%', #{mobile}, '%')
        </if>
        <if test="province != null and province != ''">
            and t.province = #{province}
        </if>
        <if test="city != null and city != ''">
            and t.city = #{city}
        </if>
        <if test="county != null and county != ''">
            and t.county = #{county}
        </if>
        <if test="balanceStatus != null">
            and t.balance_status = #{balanceStatus}
        </if>
        <if test="balanceNo != null and balanceNo != ''">
            and t.balance_no = #{balanceNo}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and t.in_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and t.in_time &lt;= #{queryEndTime}
        </if>
        <if test="isDel != null">
            and t.is_del = #{isDel}
        </if>
        <if test="fromSystem != null and fromSystem != ''">
            and t.from_system = #{fromSystem}
        </if>
    </select>

    <!-- 查询列表 带分页 -->
    <select id="queryMapForPage" resultType="Map" parameterType="Object">

        select
        t.id,t.order_no,t.customer_id,t.customer_name,t.provider_code,t.provider_name
        ,t.shop_code,t.shop_name,t.brand_id,t.brand_name,t.model_id,t.model_name,t.color
        ,t.repair_type,t.order_price,t.real_price,t.order_status,t.balance_status
        ,date_format(t.`deposit_time`,'%Y-%m-%d %H:%i:%s')deposit_time
        ,date_format(t.`dispatch_time`,'%Y-%m-%d %H:%i:%s')dispatch_time
        ,t.engineer_id,t.engineer_number,t.engineer_name,t.engineer_mobile
        ,t.mobile,t.areas,t.address,date_format(t.`in_time`,'%Y-%m-%d %H:%i:%s')in_time
        ,s.tel shop_tel,s.manager_mobile shop_manager_mobile,s.manager_name shop_manager_name
        ,t.is_use_coupon,t.coupon_id,t.coupon_code,t.coupon_name,t.coupon_type,t.coupon_price
        ,t.from_system
        ,(select count(1) from kx_engineer e where e.is_del = 0 and e.is_dispatch = 0 and e.shop_code = t.shop_code )
        eng_count

        ,date_format(now(),'%Y-%m-%d %H:%i:%s') sys_time
        ,fs.name from_system_name
        from kx_order t
        left join kx_shop s on t.shop_code = s.`code`
        left join kx_from_system fs on t.from_system = fs.id
        where 1=1
        <if test="orderNo != null and orderNo != ''">
            and t.order_no like CONCAT('%', #{orderNo}, '%')
        </if>
        <if test="customerId != null and customerId != ''">
            and t.customer_id = #{customerId}
        </if>
        <if test="customerName != null and customerName != ''">
            and t.customer_name = #{customerName}
        </if>
        <if test="providerCode != null and providerCode != ''">
            and t.provider_code = #{providerCode}
        </if>
        <if test="providerName != null and providerName != ''">
            and t.provider_name = #{providerName}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and t.shop_code like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="shopName != null and shopName != ''">
            and t.shop_name like CONCAT('%', #{shopName}, '%')
        </if>
        <if test="brandId != null and brandId != ''">
            and t.brand_id = #{brandId}
        </if>
        <if test="isUpdatePrice != null and isUpdatePrice != ''">
            and is_update_price = #{isUpdatePrice}
        </if>
        <if test="brandName != null and brandName != ''">
            and t.brand_name like CONCAT('%', #{shopCode}, '%')
        </if>
        <if test="modelId != null and modelId != ''">
            and t.model_id = #{modelId}
        </if>
        <if test="modelName != null and modelName != ''">
            and t.model_name like CONCAT('%', #{modelName}, '%')
        </if>

        <if test="orderStatus != null and orderStatus != ''">
            and t.order_status = #{orderStatus}
        </if>

        <if test="queryStatusArray != null and queryStatusArray.size() > 0">
            and t.order_status in
            <foreach collection="queryStatusArray" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="isDispatch != null">
            and t.is_dispatch = #{isDispatch}
        </if>
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>

        <if test="engineerNumber != null and engineerNumber != ''">
            and t.engineer_number like CONCAT('%', #{engineerNumber}, '%')
        </if>
        <if test="mobile != null and mobile != ''">
            and t.mobile like CONCAT('%', #{mobile}, '%')
        </if>
        <if test="province != null and province != ''">
            and t.province = #{province}
        </if>
        <if test="city != null and city != ''">
            and t.city = #{city}
        </if>
        <if test="county != null and county != ''">
            and t.county = #{county}
        </if>
        <if test="balanceStatus != null">
            and t.balance_status = #{balanceStatus}
        </if>
        <if test="balanceNo != null and balanceNo != ''">
            and t.balance_no = #{balanceNo}
        </if>
        <if test="queryStartTime != null and queryStartTime != ''">
            and t.in_time &gt;= #{queryStartTime}
        </if>
        <if test="queryEndTime != null and queryEndTime != ''">
            and t.in_time &lt;= #{queryEndTime}
        </if>
        <if test="isDel != null">
            and t.is_del = #{isDel}
        </if>
        <if test="repairType != null">
            and t.repair_type = #{repairType}
        </if>
        <if test="fromSystem != null and fromSystem != ''">
            and t.from_system = #{fromSystem}
        </if>
        order by t.in_time desc
    </select>

    <!-- 查询未处理订单数 -->
    <select id="orderMapCount" resultType="Integer" parameterType="Object">
        select count(order_no)
        from kx_order t
        where 1=1
        <if test="orderNo != null and orderNo != ''">
            and t.order_no like CONCAT('%', #{orderNo}, '%')
        </if>
        <if test="orderStatus != null and orderStatus != ''">
            and t.order_status = #{orderStatus}
        </if>
        <if test="queryStatusArray != null and queryStatusArray.size() > 0">
            and t.order_status in
            <foreach collection="queryStatusArray" item="item" open="(" separator=", " close=")">
                #{item}
            </foreach>
        </if>
        <if test="engineerId != null and engineerId != ''">
            and t.engineer_id = #{engineerId}
        </if>
        and t.is_del = 0
    </select>

    <!-- 根据订单号，修改订单状态-->
    <update id="updateByOrderNo" parameterType="Object">
        update kx_order 
        set 
            order_status=#{orderStatus},
            update_time=#{updateTime},
            is_Show=#{isShow}
        where id=#{id}
    </update>

    <!-- 得到日期内未结算订单信息 -->
    <select id="getSummaryOrderListForPage" parameterType="Object" resultType="Map">
        select t2.id,t1.provider_name providerName,
        count(t1.provider_code) orderCount,
        t2.manager_name managerName,
        t2.manager_mobile managerMobile,
        t2.account_bank accountBank,
        t2.account_bank_branch accountBankBranch,
        t2.account_name accountName,
        t2.account_number accountNumber,
        t2.proportion,
        sum(t1.real_price) amountPrice,
        t1.end_time
        from kx_order t1
        left join kx_provider t2
        on t1.provider_code = t2.code
        where t1.is_del = 0
	        and t1.order_status = 50
	        and t1.balance_status = 0
	        and t2.is_del = 0
	        and t2.status = 0
	        and t1.end_time BETWEEN #{queryStartTime} and #{queryEndTime}
        GROUP BY t1.provider_code
        ORDER BY t1.provider_code
    </select>

    <!-- 得到指定日期内各连锁商结算总金额 -->
    <select id="queryBalanceAmount" parameterType="Object" resultType="Map">
        select count(1) orderCount,
        sum(t1.real_price) amount_price,
        sum(round(t1.real_price * (1 - t2.proportion),2)) balance_amount,
        (sum(t1.real_price) - sum(round(t1.real_price * (1 - t2.proportion),2))) profit_price
        from kx_order t1
        left join kx_provider t2 on t1.provider_code = t2.code
        where t1.is_del = 0
        and t1.order_status = 50
        and t1.balance_status = 0
        and t2.is_del = 0
        and t2.status = 0
        and t1.end_time BETWEEN #{queryStartTime} and #{queryEndTime}
        <!-- 如果需要减小误差可以使用下面的算法
        select sum(orderCount) orderCount,
            sum(amount_price) amount_price,
            sum(round(amount_price * (1 - proportion),2)) balance_amount,
            (sum(amount_price) - sum(round(amount_price * (1 - proportion),2))) profit_price
        from (
            select count(1) orderCount,
            sum(t1.real_price) amount_price,
            t2.proportion
            from kx_order t1
            left join kx_provider t2
            on t1.provider_code = t2.code
            where t1.is_del = 0
            and t1.order_status = 50
            and t1.balance_status = 0
            GROUP BY t1.provider_code) tmp
         -->
    </select>

    <!-- 查询待结算的订单 -->
    <select id="queryOrderForBalance" resultMap="BaseResultMap" parameterType="Object">
        select
        <include refid="Base_Column_List"/>
        from kx_order t
        where t.is_del = 0
        and t.order_status = 50
        and t.balance_status = 0
        and t.end_time &gt;= #{queryStartTime}
        and t.end_time &lt;= #{queryEndTime}
        <if test="providerCode != null and providerCode != ''">
            and t.provider_code = #{providerCode}
        </if>
        <if test="shopCode != null and shopCode != ''">
            and t.shop_code = #{shopCode}
        </if>
    </select>

    <!-- 修改日期内订单balance状态 -->
    <update id="updateBalanceStatus" parameterType="Object">
       UPDATE kx_order SET
       balance_status=#{balanceStatus},
       balance_time=#{balanceTime},
       balance_no=#{balanceNo}
       where id = #{id} and balance_status = 0
    </update>

    <!-- 清楚balance状态 -->
    <update id="deleteBalanceStatus" parameterType="Object">
       UPDATE kx_order SET
       balance_status=0,
       balance_time=null,
       balance_no=null
       where balance_no = #{balanceNo}
    </update>
</mapper>   