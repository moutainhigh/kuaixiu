<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/resultHappyPrize.css">
	<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
    <title></title>
	<style>
		.popo-dialog.top-status{
			justify-content: flex-start;
		}
	</style>
</head>
<body class="result-prize">
    <!--start of 主内容区域-->
	<div class="main-container">
		<!--start of 顶部标题栏区域-->
		<div class="title-box">
			<div class="title-bg-box"><img src="img/resultBg.png" /></div>
			<span class="title-logo"></span>
			<div class="title-main-panel">
				<div class="intr-label">您的宝贝预估可卖</div>
				<div class="price-panel">￥<span id="priceValue" class="price-value"><img src="img/loadings.gif" alt=""></span><!--<span id="repriceBtn" class="reprice-btn">重新评估&gt;</span>--></div>
				<div class="info-panel">打败了全国<span id="percent" class="percent-value">99%</span>同机型的估价用户</div>
				<!--<div id="toShare" class="share-to-wechat-btn">分享到朋友圈</div>-->
				<!--				
				<div id="toShare" class="show-btn">快去炫耀一下</div>
				<div id="ping2" class="tipinfo-panel">参加回收免费送碎屏保</div>
				-->
			</div>
		</div>
		<!--end of 顶部标题栏区域-->
		<!--start of 优质服务区域-->
		<div class="introduce-box">
			<div class="price-trend-panel"><label>价格趋势：</label>预计下个月下降<span id="nextPriceValue" class="t-price-value"><img src="img/loadings.gif" alt=""></span>元<span class="down-arrow"></span></div>
		</div>
		<!--end of 优质服务区域-->
		<!--start of 中奖区域-->
		<div class="prize-box">
	
			<!--start of 刮奖区域-->
			<div class="prize-panel">
				<dl class="status-list">
					<dd id="hasPrize" class="status-item result-ok-status">
						<div id="prizeIntr" class="prize-intr">恭喜您，中了#等奖！</div>
						<div id="gotoExchangeBtn" class="prize-btn">立即兑换</div>
					</dd>
					<dd id="hasNoPrize" class="status-item result-no-status">
						<div class="prize-content">先分享再来抽奖吧！</div>
						<div class="prize-desc">转发评估结果到微信群<br>可以增加一次抽奖哦！</div>
						<div id="sharePageBtn1" class="prize-btn">立即转发</div>
					</dd>
					<dd id="hasNoPrizeAndShare" class="status-item result-no-status">
						<div class="prize-title">很遗憾，未中奖！</div>
						<div class="prize-desc">转发评估结果到微信群<br>可以增加一次抽奖哦！</div>
						<div id="sharePageBtn2" class="prize-btn">立即转发</div>
					</dd>
					<dd id="cardCanvas"  class="status-item check-prize-status show">
						
					</dd>
					<dd id="startPrizeCard" class="status-item start-status show">
						<div class="prize-intr">赢小米8SE、小米手环3</div>
						<div id="showPopoDialogBtn" class="prize-btn">点我抽奖</div>
					</dd>
				</dl>
			</div>
			<!--end of 刮奖区域-->
			<div class="question-tip">如有疑问请点击<a id="showPrizeIntrPage">抽奖须知</a></div>
			 <div class="question-tip">查询中奖信息请点击<a id="checkPrizePage">中奖查询</a></div>
		</div>
		<!--end of 中奖区域-->
		<!--start of 优质服务区域-->
		<div class="introduce-box">
			<div class="slogan-box"><span>优质服务，值得信赖</span></div>
			<dl class="intr-item-list">
				<dd class="intr-item">
					<div class="intr-item-icon"><img src="img/icon_1@2x.png" /></div>
					<div class="intr-item-text">上门取件</div>
				</dd>
				<dd class="intr-item">
					<div class="intr-item-icon"><img src="img/icon_2@2x.png" /></div>
					<div class="intr-item-text">顺丰包邮</div>
				</dd>
				<dd class="intr-item">
					<div class="intr-item-icon"><img src="img/icon_3@2x.png" /></div>
					<div class="intr-item-text">安全便捷</div>
				</dd>
			</dl>
		</div>
		<!--end of 优质服务区域-->
	</div>
	<!--end of  主内容区域-->
	<!--start of 底部区域-->
	<div class="buttom-box">
		<span id="exchangeMoneyBtn" class="action-btn">马上换钱</span>
	</div>
	<!--end of 底部区域-->
	<!--start of 弹出对话框-->
	<div id="popoDialog" class="popo-dialog hide">
		<div id="phone-dialog-box" class="dialog-box">
			<div class="dialog-title">温馨提示</div>
			<div class="dialog-body">
				<div class="tipinfo-box">抽奖需要先填写领奖手机号，方便中奖后我们及时联系您，请填写以下信息后点击立刻抽奖。</div>
				<div class="input-item">
					<input id="phoneNum" class="popodlg-input" type="text" placeholder="请输入手机号" />
				</div>
				<div class="input-item">
					<input id="codeNum" class="short-input popodlg-input" type="text" placeholder="请填写验证码" />
					<span id="getCodeBtn" class="input-label active-btn">获取验证码</span>
					<span id="secondLabel" class="input-label info-box">60秒</span>
				</div>
				<div class="input-item">
					<span id="doPrizeBtn" class="do-prize-btn">立刻抽奖</span>
				</div>
			</div>
			<span id="closePopoDialogBtn" class="close-btn">X</span>
		</div>
	</div>
	<!--end of 弹出对话框-->
	
    <script src="js/jquery.js"></script>
    <script src="js/ctcard.min.js"></script>
    <script src="js/util.js"></script>
	<script>
		function getUrlParam(key){
			var url = window.location.search;
			var reg = new RegExp("(^|&)"+ key +"=([^&]*)(&|$)");
			var result = url.substr(1).match(reg);
			return result ? decodeURIComponent(result[2]) : null;
		}
		
		function setCacheData(key,keyName){
			if(getUrlParam(keyName)!==null &&  getUrlParam(keyName) !== undefined && getUrlParam(keyName)!==''){
			  eCacheUtil.storage.cache(key,getUrlParam(keyName));
			}
		}
		
		if (getUrlParam("productid")){
		    setCacheData(CacheKey.SelectItems,"SelectItems");
			setCacheData(CacheKey.ProjectId,"productid");
			setCacheData(CacheKey.OpenId,"openId");
			setCacheData(CacheKey.ModelName,"modelName");
			setCacheData(CacheKey.ModelCode,"modelCode");
			setCacheData(CacheKey.imgHref,"modelImageUrl");
			setCacheData(CacheKey.LastPrice,"lastPrice");
			eCacheUtil.storage.cache(CacheKey.isSelect,false);
		}
		
		function onShare(){
           CtclientJS.share('天翼回收', 
					'你的手机还值多少钱，要不我送一部', 
					'http://m-super.com/ty_wap/img/happygo_share.png', 
					'http://m-super.com/ty_wap/?fm=9&ticket=$ticket$')
		   }
    </script>
    <script>
        $(function(){
			window.G = window.G || {};
            //储存来源和标示
            var tip =eCacheUtil.storage.getCache(CacheKey.happyGo);
            var fm=eCacheUtil.storage.getCache(CacheKey.source);
            if(isEmpty(tip)||!isEmpty(GetQueryString('tip'))) {
                eCacheUtil.storage.cache(CacheKey.happyGo, true);
            }
            if(isEmpty(fm)){
                eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
            }

            //初始化图片面板
			var ctcard = window.CT_Card({
				id:'cardCanvas',
				watermarkImg:'img/result-prizeitem-bg.png',             //水印图片的地址
				watermarkWidth:60,            //水印的尺寸
				watermarkHeight:90,
			});
			ctcard.init( function(){
				ctcard.reset();
			});
			
			
			//b. 事件注册
			//b.1 重新评估事件
			$('#repriceBtn').click( function(){
				eCacheUtil.storage.cache(CacheKey.isSelect,false);
				eCacheUtil.storage.removeCache(CacheKey.prePrice);
				window.location.href = 'test.html';
			});
			
			//跳转到碎屏保
			$('#ping2').click( function(){
				location.href = 'https://m-super.com/screen/list.html?r=RJ1WZFV5HB5XEWAA3P57';
			});
			
			//b.3 兑换奖项
			$('#gotoExchangeBtn').click( function(){
				//从欢Go的客户端加载页面
				//alert( '请先提交一个回收订单再兑换。' );
				var param = {
					"mobile":G.HappyGoMobile,
				};
				$.post(
					getRealPath()+"/recycle/isSaveAddress.do",
					{
						params:JSON.stringify(param)
					},
					function(data){
						if ( data.success){
							if( data.result.isSave ){
								//已经保存了收获地址
								//TODO 跳转
								window.location.href = 'resultQueryHappy.html' ;
							}
							else{
							    eCacheUtil.storage.cache(CacheKey.ToHappyGoPage,"resultQueryHappy.html");
								//跳转到输入联系方式的页面
								window.location.href = "resultOrderInfo.html";
							}
							
						}else{
							alert(data.resultMessage);
						}
						
						G.isPosting = false ;
					});
				return ;
			});
			
			
			//b.5 立即转发
			$('#sharePageBtn1').click( function(){
			    //从欢Go的客户端加载页面
				//TODO 设置分享的具体内容
				CtclientJS.share( 
					'天翼回收', 
					'你的手机还值多少钱，要不我送一部', 
					'http://m-super.com/ty_wap/img/happygo_share.png', 
					'http://m-super.com/ty_wap/?fm=9&ticket=$ticket$'
					 );
					 
				//更新用户分享成功的记录
				updateShareStatus();
				
			});
			
			$('#sharePageBtn2').click( function(){		    
			    //从欢Go的客户端加载页面
				//TODO 设置分享的具体内容
				CtclientJS.share( 
					'天翼回收', 
					'你的手机还值多少钱，要不我送一部', 
					'http://m-super.com/ty_wap/img/happygo_share.png', 
					'http://m-super.com/ty_wap/?fm=9&ticket=$ticket$'
					 );
					 
				//更新用户分享成功的记录
				updateShareStatus();
			});
			//b.6 立刻抽奖
			$('#doPrizeBtn').click( function(){
				var phoneNum = $('#phoneNum').val();
				var codeNum = $('#codeNum').val();
				
				if( phoneNum === '' ){
					alert( '手机号不能为空' );
					$('#phoneNum').focus();
					return ;
				}
				
				if( codeNum === '' ){
					alert( '验证码不能为空' );
					$('#codeNum').focus();
					return ;
				}
				
				//向后台请求数据
				if( G.isPosting ){
					return ;
				}
				G.isPosting = true ;
				
				//a 记录抽奖号码
				var param = {
					"mobile":phoneNum,
					"openId":G.openId,
					"code":codeNum
				};
				$.post(
					getRealPath()+"/recycle/saveLotteryMobile.do",
					{
						params:JSON.stringify(param)
					},
					function(data){
						if ( data.success){
							//关闭弹出框
							$("#popoDialog").addClass( 'hide' );
							//获得抽奖信息
							getPrizeInfo();
							
						}else{
							alert(data.resultMessage);
						}
						
						G.isPosting = false ;
					});

				return ;
			});
			
			//b.7 显示/关闭弹出框
			$('#showPopoDialogBtn').click( function(){
				if( G.HappyGoMobile == '' ){
					getPrizeInfo();
				}
				else{
					//直接用欢Go带过来的手机号码进行抽奖
					getPrizeInfoByHappyGo( G.HappyGoMobile );
				}

				return ;
			});
			$('#closePopoDialogBtn').click( function(){
				$("#popoDialog").addClass( 'hide' );
			});
			
			//b.8 马上换钱
			$('#exchangeMoneyBtn').click( function(){
				eCacheUtil.storage.cache(CacheKey.quoteId,G.quoteid);
                eCacheUtil.storage.cache(CacheKey.prePrice,G.prePrice);
                location.href = 'test.html';
			});
			
			//b.9 获取验证码
			$('#getCodeBtn').click( function(){
				var phoneNum = $('#phoneNum').val();
			
				if( phoneNum === '' ){
					alert( '请先输入手机号' );
					$('#phoneNum').focus();
					return ;
				}
				
				if( G.isPosting ){
					return ;
				}
				G.isPosting = true ;

				//发送服务器请求
				var param = {
					"mobile":phoneNum
				}
				 //TODO
				 $.post(
					getRealPath()+"/wechat/sendSmsCode.do",
					{
						params:JSON.stringify(param)
					},
					function(data){
						if (data.success){
							//启动计数定时器
							startSecondCount();
							//设置发送验证码的状态
							$('#phone-dialog-box').addClass( 'sending-code' );
							
						}else{
							alert(data.resultMessage);
						}
						
						G.isPosting = false ;
					});
				
			});
			
			//b. 开始倒计时
			function startSecondCount( ){
				G.secondValue = 60 ;
				$('#secondLabel').html( G.secondValue + '秒' );
				updateSecondCount();
			}
			function updateSecondCount( ){
				setTimeout( function(){
					G.secondValue = G.secondValue -1 ;
					if( G.secondValue > 0  ){
						$('#secondLabel').html( G.secondValue + '秒' );
						//调用自身
						updateSecondCount();
					}
					else{
						$('#phone-dialog-box').removeClass( 'sending-code' );
					}
				},1000 );
				return ;
			}
			
			//b.10 显示抽奖须知
			$('#showPrizeIntrPage').click( function(){
				window.location.href = 'resultHappyPrizeIntr.html' ;
			});
			
			//跳转到奖品查询页面
			$('#checkPrizePage').click( function(){
				window.location.href = 'resultQueryHappy.html' ;
			});
			
			//b.11 输入状态时，弹窗状态优化
			$('.popodlg-input').focus( function(){
				$('#popoDialog').addClass( 'top-status' );
			});
			$('.popodlg-input').blur( function(){
				$('#popoDialog').removeClass( 'top-status' );
			});
			
			//c.
			//c.1 获取抽奖信息
			var getPrizeInfo = function(){
				if( G.doPrize ){
					return ;
				}
				G.doPrize = true ;
				
				G.openId = eCacheUtil.storage.getCache(CacheKey.OpenId);
                var paramData = {
                    "openId":G.openId
				};
                $.post(getRealPath()+'/recycle/getPrize.do',{params:JSON.stringify(paramData)},function (data) {
                    if (data.success){ 
						//判断抽奖手机是否已经保存
						if( data.result.status == 1 || data.result.status == 3){
							//弹出框，提示输入抽奖手机
							$('#phoneNum').val( '' );
							$('#codeNum').val( '' );
							$('#popoDialog').removeClass( 'hide' );
						}
						else{
							//G.candoPrizeCount = parseInt( data.result.surplusLotteryNumber );  //剩余的抽奖次数
							G.candoPrizeCount = data.result.surplusLotteryNumber;
							G.shareState = data.result.shareState ;                    //是否已经分享
							G.currentPrizeState = data.result.currentPrizeState ;      //当前是否中奖
							G.prizeInfo = data.result.prizeInfo ;                      //获奖的信息
							G.tip = data.result.tip ;                                  //当前抽奖状态
							G.prizeMobile=data.result.prizeMobile;             //抽奖手机号
							
							
							//将获奖信息缓存到缓存中
							if( window.localStorage ){
								localStorage.setItem( 'prizeinfo' , JSON.stringify( G.prizeInfo ) );
							}
							
							
							//把参加抽奖的手机号存起来
							eCacheUtil.storage.cache(CacheKey.prizeMobile,G.prizeMobile);
							
							//更新中奖的状态
							updatePrizeStatus();
						}

                    }else {
                        alert(data.resultMessage);
                    }
					G.doPrize = false ;
                });
				
				
				return ;
			}
			
			//c.1.2 根据欢Go带过来的手机号码进行抽奖
			var getPrizeInfoByHappyGo = function( happyGoMobile ){
				if( G.doPrize ){
					return ;
				}
				G.doPrize = true ;
				
                var paramData = {
                    "mobile":happyGoMobile
				};
                $.post(getRealPath()+'/recycle/getRecyclePrize.do',{params:JSON.stringify(paramData)},function (data) {
                    if (data.success){ 
						//G.candoPrizeCount = parseInt( data.result.surplusLotteryNumber );  //剩余的抽奖次数
						G.candoPrizeCount = data.result.surplusLotteryNumber;
						G.shareState = data.result.shareState ;                    //是否已经分享
						G.currentPrizeState = data.result.currentPrizeState ;      //当前是否中奖
						G.prizeInfo = data.result.prizeInfo ;                      //获奖的信息
						G.tip = data.result.tip ;                                  //当前抽奖状态
						G.prizeMobile=data.result.prizeMobile;                      //抽奖手机号
						
						//将获奖信息缓存到缓存中
						if( window.localStorage ){
							localStorage.setItem( 'prizeinfo' , JSON.stringify( G.prizeInfo ) );
						}	
						
						//把参加抽奖的手机号存起来
						eCacheUtil.storage.cache(CacheKey.prizeMobile,G.prizeMobile);
						
						//更新中奖的状态
						updatePrizeStatus();

                    }else {
                        alert(data.resultMessage);
                    }
					G.doPrize = false ;
                });
				
				
				return ;
				
			}
			
			//c.2 更新获奖的状态
			var updatePrizeStatus = function(){
				//G.candoPrizeCount = parseInt( data.result.surplusLotteryNumber );  //剩余的抽奖次数
				//G.shareState = data.result.shareState;                    //是否已经分享
				//G.currentPrizeState = data.result.currentPrizeState ;      //当前是否中奖
				//G.prizeInfo = data.result.prizeInfo ;                      //获奖的信息
				
				//判断当前是否已经中奖
				if( G.currentPrizeState == 1 ){
					//中奖了
					var prizeIntr = formatPrizeIntr( G.prizeInfo );
					$('#prizeIntr').html( prizeIntr );
					$('#hasPrize').addClass( 'active' ).siblings().removeClass( 'active' );
				}else{
					//未中奖
					//判断是否已经分享过信息
					//if( G.candoPrizeCount == 1 && G.shareState == 0 ){
						//提示它分享
					//	$('#hasNoPrizeAndShare').addClass( 'active' ).siblings().removeClass( 'active' );
					//}
					//else{
						//未分享，提示分享后再来抽奖
					//	$('#hasNoPrize').addClass( 'active' ).siblings().removeClass( 'active' );
					//}
					
					if( G.tip){
						//提示分享
				       $('#hasNoPrizeAndShare').addClass( 'active' ).siblings().removeClass( 'active' );
					}else{
				    	//未分享，提示分享后再来抽奖
						$('#hasNoPrize').addClass( 'active' ).siblings().removeClass( 'active' );
					}
					
				
				}//end of else, 未中奖的情况
				
				//隐藏'点我抽奖'提示的按钮
				$('#startPrizeCard').removeClass( 'show' );
				
				return ;
			}
			
			//c.3 格式化中奖信息
			var formatPrizeIntr = function( prizeInfo ){
				var prizeName = '';
				switch( prizeInfo.grade ){
					case 1:
						prizeName = '小米8SE' ;
						break ;
					case 2:
						prizeName = '小米手环3' ;
						break ;
					case 3:
						prizeName = '天猫精灵' ;
						break ;
					case 4:
						prizeName = '手机话费10元' ;
						break ;
				};
				var result = '恭喜您，中了'+prizeName;
				return result ;			
			}
			
			//c.4 更新用户分享成功的记录
			var updateShareStatus = function(){
					//更新当前用户已经分享成功
					if( G.isPosting ){
						return ;
					}
					G.isPosting = true ;

					//发送服务器请求
					var param = {
						"loginMobile":G.HappyGoMobile,
						"status":true,
					}
					$.post(
						getRealPath()+"/recycle/recycleShare.do",
						{
							params:JSON.stringify(param)
						},
						function(data){					
							G.isPosting = false ;
							//刷新当前页面
							window.location.reload();
						});
			}
			
			//c.end 初始化函数
			var init = function(){
				//1.先从缓存中获得selectItem 和 productId
				
				G.brandId = eCacheUtil.storage.getCache( CacheKey.BrandId );
				G.productid = eCacheUtil.storage.getCache( CacheKey.ProjectId );
				G.itemsId = eCacheUtil.storage.getCache( CacheKey.SelectItems );
				G.openId = eCacheUtil.storage.getCache( CacheKey.OpenId );
				G.modelName = eCacheUtil.storage.getCache( CacheKey.ModelName );
				G.modelCode = eCacheUtil.storage.getCache( CacheKey.modelCode );
				G.LastPrice = eCacheUtil.storage.getCache( CacheKey.LastPrice );
				
				G.source = eCacheUtil.storage.getCache( CacheKey.source );      //判断页面来源
				
				G.HappyGoMobile = eCacheUtil.storage.getCache( CacheKey.HappyGoMobile );
				
				//2.获取评估价格和下周下降的价格
                var paramData = {
					"loginMobile":G.HappyGoMobile,
					"brandId":G.brandId,
					"productId":G.productid
					
				};
				
                $.post(getRealPath()+'/recycle/getDeclinePrice.do',{params:JSON.stringify(paramData)},function (data) {
                    if (data.success){
                        var dataInfo = data.result.datainfo; 
						//设置当前价格
                        $('#priceValue').html( dataInfo.price );
						//设置击败人数百分比
						$('#percent').html( dataInfo.percent+'%' );
						//设置下周的价格
						$('#nextPriceValue').html( dataInfo.nextPirce );
						G.prePrice = dataInfo.price ;
						G.quoteid = dataInfo.quoteid ;


						//把当前估价和击败用户百分比存起来
						eCacheUtil.storage.cache(CacheKey.ModelPrice,dataInfo.price);
						eCacheUtil.storage.cache(CacheKey.ModelPercent,dataInfo.percent);

                    }else {
                        alert(data.resultMessage);
                    }
                });

			}
			
			
			
			//e.
			init();
        });
    </script>
</body>
</html>