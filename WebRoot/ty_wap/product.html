<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/flexible.js"></script>
    <link rel="stylesheet" href="css/main.css?version=1.6">
    <title></title>
    <style>
        .native-model {
             display: none;
             flex-basis: 2.55rem;
             overflow: hidden;
             margin-bottom: 0.1rem;
             padding: 0.1rem 0.05rem;
             background-color: white;
             box-shadow: 0.01rem 0.01rem 0.06rem 0.02rem #e6e3e3;
        }
         .native-fl {
             float: left;
             width: 30%
        }
         .native-fl img {
             width: 100%;
        }
         .native-fr {
             float: right;
             width: 70%;
             height: 100%;
        }
         .native-top, .native-bot {
             width: 100%;
             height: 50%;
             overflow: hidden;
        }
         .native-top .native-title {
             float: left;
             font-size: 0.16rem;
             font-weight: 600;
        }
         .native-top .native-btn {
             float: right;
             display: block;
             width: 0.75rem;
             height: 0.3rem;
             line-height: 0.3rem;
             text-align: center;
             background: #5185ed;
             color: #fff;
        }
         .native-bot {
             padding-top: 0.05rem;
             box-sizing: border-box;
        }
         .native-bot .native-code {
             font-size: 0.18rem;
             font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="wrap" class="productWrap">
        <div class="pageTitle" style="background: linear-gradient(to right, #3f99f2, #5185ed);">
            <a href="javascript:window.history.back();"><img src="img/icon_arrow.png" alt=""></a>
            <div>
                <input type="search" name="" id="search" placeholder="输入手机型号">
            </div>
        </div>
        <div class="main clearfix">
            <div class="mainLeft fl">
                <ul class="swiper-wrapper">

                </ul>
            </div>
            <div class="mainRight fl">
                <!-- start of 本机机型 -->
                <div class="native-model">
                        <div class="native-fl">
                            <img class="js-native-img" src="" alt="">
                        </div>
                        <div class="native-fr">
                            <div class="native-top">
                                <span class="native-title">本机机型</span>
                                <a class="native-btn js-native-btn">立即估价</a>
                            </div>
                            <div class="native-bot">
                                <p class="native-code js-native-code"></p>
                            </div>
                        </div>
                </div>
                <!-- end of 本机机型 -->
                <div class="loadMore">
                    <a href="javascript:;" class="btn-large">加载更多</a>
                </div>
            </div>
            <div id="template" style="display:none;">
                <div class="item"></div>

            </div>
        </div>

        <!--错误提示-->
        <div class="remind_delivery_bg">
            <div class="remind_delivery_cont">
                <p></p>
            </div>
        </div>
        <!--错误提示end-->
        <!--遮盖层-->
        <div id="mask_boxs">
            <div id="mcon">
                <img src="img/loadings.gif"/>
            </div>
        </div>
    </div>
    <script src="js/jquery.js"></script>
    <script src="js/swiper.min.js"></script>
    <script src="js/common.js"></script>

    <script>
        var fm=eCacheUtil.storage.getCache(CacheKey.source);
        console.log(fm);
        if(isEmpty(fm)){
            eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
        }
        var otherLoginPhone = eCacheUtil.storage.getCache(CacheKey.loginPhone);

        if(isEmpty(otherLoginPhone)){
            if(GetQueryString('phone')) {
                eCacheUtil.storage.cache(CacheKey.loginPhone,GetQueryString('phone'));
            }

        }

		if(fm == 2 || fm == 9 || fm == 10){
			document.title = '天翼回收';
		}else{
			document.title = '翼回收';
		}

        var ModelName_cache = '';
        var ProjectId_cache = '';

        function GetUrlParam(paraName) {
            var url = document.location.toString();
            var arrObj = url.split("?");

            if (arrObj.length > 1) {
                var arrPara = arrObj[1].split("&");
                var arr;

                for (var i = 0; i < arrPara.length; i++) {
                    arr = arrPara[i].split("=");

                    if (arr != null && arr[0] == paraName) {
                        return arr[1];
                    }
                }
                return "";
            }
            else {
                return "";
            }
        }
        var codeId = GetUrlParam('codeId');
        eCacheUtil.storage.cache('discount_info_infos',codeId);



        // 首次进入获取本机型
        function getNativeModel(mobileData){
            var brandId = getUrlParam('brandId');  //品牌
            var productId = getUrlParam('productId'); //型号
            var $dom_li = $('.mainLeft li.swiper-slide');

            $('.native-model').show();
            // 跳转到指定品牌, 如果没有这两个参数则不做任何操作
            for( var i = 0; i < $dom_li.length; i++ ){
                if( brandId == $dom_li.eq(i).data('bid') ){
                    var height = $dom_li.eq(i).height()*i;
                    $('.mainLeft .swiper-wrapper').css('transform','translate3d(0px, -'+height+'px, 0px)')
                    $dom_li.eq(i).addClass('active').siblings().removeClass('active');
                }
            }

            ModelName_cache =  mobileData.modelName;
            ProjectId_cache = getUrlParam('productId');

            $('.js-native-img').attr('src', mobileData.modelLogo);
            $('.js-native-code').text( mobileData.modelName )
        }

		function getUrlParam(key){
			var url = window.location.search;
			var reg = new RegExp("(^|&)"+ key +"=([^&]*)(&|$)");
			var result = url.substr(1).match(reg);
			return result ? decodeURIComponent(result[2]) : null;
		}

		function setCacheData(key,keyName){
			if(getUrlParam(keyName)!==null &&  getUrlParam(keyName) !== undefined && getUrlParam(keyName)!==''){
			  eCacheUtil.storage.cache(key,getUrlParam(keyName));
			}
		}

		if (getUrlParam("openId")){
			setCacheData(CacheKey.OpenId,"openId");
			setCacheData(CacheKey.ModelName,"modelName");
			setCacheData(CacheKey.imgHref,"modelImageUrl");
            // setCacheData(CacheKey.imgHref,"modelLogo");
			eCacheUtil.storage.cache(CacheKey.isSelect,false);
		}

        var page = 1, //分页码
            off_on = false,//分页开关
            totalcount = 0;
        $(function(){
            var tip = GetQueryString('tip');
            var fm = eCacheUtil.storage.getCache(CacheKey.source);
            if(isEmpty(fm)){
                eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
            }
        	if(tip==1){
        		 eCacheUtil.storage.cache(CacheKey.happyGo,true);
        	}
            var bid = GetQueryString('bid');
            if(isEmpty(bid)){
                bid = 1;
            }
            searchBrand(bid);
            eCacheUtil.storage.cache(CacheKey.isSelect,false);
            //选择品牌
            $('.mainLeft').on('click','li',function () {
                if (!$(this).hasClass('active')){
                    $(this).addClass('active').siblings().removeClass('active');
                    bid = $(this).attr('data-bid');
                    $('.mainRight div.item').remove();
                    searchModel(bid);
                }
            });

            $('.mainRight').delegate('.item','click',function(){
                var mid = $(this).attr('data-mid'),
                    mname = $(this).find('p').html(),
                    imgHref = $(this).find('img').attr('src')
                eCacheUtil.storage.cache(CacheKey.ProjectId,mid);
                eCacheUtil.storage.cache(CacheKey.ModelName,mname);
                eCacheUtil.storage.cache(CacheKey.imgHref,imgHref);
                setHistoryItems(mname,mid,imgHref);
                //判断是否良品价评估
                var fm=eCacheUtil.storage.getCache(CacheKey.source);
                /*if(fm==10){
                    location.href = 'resultHappyPrize.html';
                }else{
                    location.href = 'test.html';
                }*/

				location.href = 'test.html';
            });

            $('.loadMore').click(function(){
                if (off_on){
                    $('.loadMore a').html('加载中');
                    page++;
                    searchModel(bid);  //调用执行上面的加载方法
                }
            });

            $('#search').focus(function(){
                location.href = "search.html";
            })

            // 立即估价
            $('.js-native-btn').on('click',function(){
                var brandId = getUrlParam('brandId');  //品牌
                var productId = getUrlParam('productId'); //型号
                eCacheUtil.storage.cache(CacheKey.ModelName, ModelName_cache);
                eCacheUtil.storage.cache(CacheKey.ProjectId, ProjectId_cache);
                location.href = "test.html";
            })
        });

        //加载品牌
        function searchBrand(bid) {
            $.post(linkUrl+"/recycleNew/getBrandList.do",function(data){
                if (data.success){
                    var s = '',dataInfo = data.result.datainfo;
                    for (var i = 0;i < dataInfo.length;i++){
                        s += '<li class="swiper-slide" data-bid="'+dataInfo[i].brandid+'">'+dataInfo[i].brandname+'</li>';
                    }
                    $('.swiper-wrapper').html(s);
                    if( getUrlParam('brandId') ){
                        searchModel( getUrlParam('brandId') );
                    }else{
                        searchModel(bid);
                    }
                    getMobileCode();
                    $('.swiper-slide[data-bid="'+bid+'"]').addClass('active');
                    var mySwiper = new Swiper('.mainLeft',{
                        freeMode : true,
                        slidesPerView : 'auto',
                        slideToClickedSlide:true,
                        direction: 'vertical'
                    });
                    $('.swiper-wrapper').css({
                        'transform' : 'translate3d(0,-'+$('.swiper-slide.active').height()*$('.swiper-slide.active').index()+'px,0)'
                    });
                }else {
                    loading_hide();
                    alertTip(data.resultMessage);
                }
            });
        }

        //加载机型
        function searchModel(bid) {
            var param = {
                pageindex:page,
                pagesize:'12',
                brandid:bid
            };
            //将品牌id储存
            eCacheUtil.storage.cache(CacheKey.BrandId,bid);
            $.post(linkUrl+"/recycleNew/getModelList.do",{params:JSON.stringify(param)},function(data){
                if (data.success){
                    var dataInfo = data.result.datainfo;
                    totalcount = data.result.totalcount;
                    if (dataInfo.length > 0){
                        var sublist = dataInfo[0].sublist;
                        eachFull(sublist);
                        loading_hide();
                        if ($('.mainRight .item').length == totalcount){
                            off_on = false;
                            $('.loadMore a').html('- 我是有底线的 -');
                        }else{
                            off_on = true;
                            $('.loadMore a').html('加载更多');
                        }
                    }
                }else {
                    loading_hide();
                    if(data.resultMessage){
                        alertTip(data.resultMessage);
                    }else{
                        alertTip(data.msg);
                    }

                }
            })
        }

        // 获取本机型
        function getMobileCode() {
            var param = {
                brandId : getUrlParam("brandId"),  //品牌
                productId : getUrlParam("productId") //型号
            }

            if( param.brandId == null || param.productId == null  ){
                return
            }

            $.post(linkUrl+"/recycleNew/getModelName.do",{params:JSON.stringify(param)},function(data){
                if (data.success){
                    var dataInfo = data.result;
                    getNativeModel(dataInfo);
                }else {
                    loading_hide();
                    alertTip(data.resultMessage);
                }
            })
        }

        function eachFull(info) {
            $.each(info, function (i, n) {
                var len=$('.mainRight div.item').length+1;
                var tmp = $("#template").clone();
                tmp.removeAttr("id");
                tmp.show();
                //$(".item",tmp).attr('data-mid',n.productid).html('<img src="'+n.modellogo+'"><p>'+n.modelname+'</p>');
                $(".item",tmp).attr('data-mid',n.productid).html('<span class="num">'+len+'</span><p>'+n.modelname+'</p>');
                //追加到对应区块
                $(".loadMore").before(tmp.html());
            });
        }
    </script>
<!--站长统计-->
<div style="display: none;">
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261469862'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1261469862%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
</body>
</html>
