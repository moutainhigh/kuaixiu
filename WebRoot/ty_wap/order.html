<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/flexible.js"></script>
    <link rel="stylesheet" href="css/main.css?version=1.6">
	<link rel="stylesheet" href="css/addPriceTicket.css">
    <title></title>
    <style>
        #wrap.orderWrap .main .ticket .ticket-box {
            justify-content: space-between;
            margin-top: 0;
            color: red;
        }

        #wrap.orderWrap .main .ticket .ticket-box i {
            font-style: normal;
        }

        .all-coupons  {
            position: relative;
            padding-right: 0.15rem;
        }

        .all-coupons p {
            position: absolute;
            right: 0;
            top: 2px;
        }

        .all-coupons p img {
            display: block;
            width: .06rem;
        }
    </style>
</head>
<body>
    <div id='map-container'></div>
    <div id="wrap" class="orderWrap">
        <div class="pageTitle">
            <a href="javascript:window.history.back();">
                <img src="img/icon_arrow.png" alt="">
            </a>
            <h3>填写取件地址</h3>
        </div>
        <div class="main">
            <div class="baseInfo">
                <div class="inputRow">
                    <p>联系人</p>
                    <input type="text" name="" id="connect" maxlength="12" placeholder="请输入联系人">
                </div>
                <div class="inputRow">
                    <p>手机号</p>
                    <input class="text" id="inputtel" type="tel" value="" maxlength="11" placeholder="请输入手机号" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')" />
                </div>
                <div class="inputRow">
                    <p>备注</p>
                    <input type="text" name="" id="note" maxlength="128" placeholder="填写备注信息(非必填)">
                </div>
            </div>
            <div class="addressInfo">
                <p class="moduleTitle">所在地址填写</p>
                <div id="selectAddress" class="eachRow">
                    <p class="default-addr">所在地区</p>
                    <p><img src="img/icon_arrow.png" alt=""></p>
                </div>
                <div class="inputRow">
                    <input class="text mustText" id="address" maxlength="64" type="text" value="" placeholder="街道、小区门牌等详细地址">
                </div>
            </div>
            <div class="postInfo">
                <p class="moduleTitle">快递方式</p>
                <div class="postway">
                    <label class="label" data-way="postText">
                        <input checked="checked" name="post" type="radio" value="1" />
                        <i class="radio_icon"></i>
                        <span class="genre">顺丰上门回收</span>
                        <img src="img/free.png" alt="">
                    </label>
                    <div id="pickTime">
                        <p>选择上门取件时间</p>
                        <p>一小时以内<img src="img/icon_arrow.png" alt=""></p>
                    </div>
                </div>
                <div class="postway">
                    <label class="label" data-way="postText">
                        <input name="post" type="radio" value="2" />
                        <i class="radio_icon"></i>
                        <span class="genre">自行邮寄</span>
                    </label>
                    <p>待快递寄出后，请到订单详情页填写快递单号<span>【请选择到付】</span></p>
                </div>
            </div>

            <div class="recycleWay">
                <p class="moduleTitle">回收方式</p>
                <div class="eachRow">
                    <label class="label" data-way="phoneText">
                        <input checked="checked" name="way" type="radio" value="2" />
                        <i class="radio_icon"></i>
                        <span class="genre">话费充值</span>
                        <img src="img/icon_hot.png" alt="">
                    </label>
                    <label class="label" data-way="alipayText">
                        <input name="way" type="radio" value="1" />
                        <i class="radio_icon"></i>
                        <span class="genre">支付宝付款</span>
                    </label>
                </div>
                <div class="inputRow" id="alipayBox">
                    <input id="alipay2" class="text mustText phoneText" data-way="call" maxlength="11"  type="text" value="" placeholder="请输入手机充值号码" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')">

                    <input id="alipay1" class="text mustText alipayText" data-way="alipay" style="display:none;" type="text" value="" placeholder="请输入支付宝账号">

                </div>
            </div>
            <div class="notice">
                <div class="phoneText1 active">
                    <p>*旧机换话费（客服0571-87162535、4008110299）</p>
                    <p>1.请正确填写所需充值的手机号码</p>
                    <p>2.下单后请在24小时内将手机通过顺丰到付邮寄给我们</p>
                    <p>3.收到手机后1-2个工作日内为您提供的手机号码进行充值</p>
                    <p>该活动的解释权由手机超人回收团队所有</p>
                </div>
                <div class="alipayText1">
                    <p>*为了方便我们能及时联系到您并且正常给您打款，请填写正确的信息</p>
                </div>
                
            </div>
            <div class="ticket">
                 <p class="moduleTitle">加价券</p>
                 <div class="ticket-box js-ticket-btn">
                    <span class="js-current-coupons">
                        加价: 
                        <i>0</i>
                        元
                    </span>
                    <span class="all-coupons js-all-coupons">
                        还有
                        <i>0</i>
                        张可用
                        <p><img src="img/icon_arrow.png" alt=""></p>
                    </span>
                    <!-- <input id="ticket-text" type="text" value="" placeholder="请输入加价券码"> -->
                 </div>
            </div>
            <div class="mailing_addr">
                <p class="moduleTitle">快递收件地址</p>
                <!-- 邮寄地址 -->
                <div class="inputRow">
                    <p>邮寄地址：</p>
                    <p>浙江省杭州市下城区武林广场东侧电信营业三楼厅</p>
                </div>
                <div class="inputRow">
                    <p>陈晓君（收）</p>
                    <p>0571-87162535</p>
                </div>
            </div>
            <div class="footer">
                <a href="javascript:;" id="submit" class="btn-large">提交订单</a>
            </div>
        </div>
        <!-- 取件时间layer -->
        <div id="layer">
            <div class="layerCont">
                <div class="layerTitle">
                    <p>选择上门取件时间</p>
                    <a href="javascript:;" class="cancel" onclick="fn_close('layer')">×</a>
                </div>
                <div class="selTime clearfix">
                    <div class="timeLeft fl">
                        <ul>
                        </ul>
                    </div>
                    <div class="timeRight fl">
                    </div>
                </div>
            </div>
            <div id="template" style="display: none;">
                <ul>
                    <li>9:00-10:00</li>
                    <li>10:00-11:00</li>
                    <li>11:00-12:00</li>
                    <li>12:00-13:00</li>
                    <li>13:00-14:00</li>
                    <li>14:00-15:00</li>
                    <li>15:00-16:00</li>
                    <li>16:00-17:00</li>
                </ul>
            </div>
        </div>
        <!-- 选择地区layer -->
        <div id="addrLayer">
            <div class="layerCont">
                <div class="layerTitle">
                    <p>所选地区</p>
                    <a href="javascript:;" class="cancel" onclick="fn_close('addrLayer')">×</a>
                </div>
                <div class="selectAddr">
                    <div id="selected">
                        <span id="s_Province"></span>
                        <span id="s_City"></span>
                        <span id="s_County"></span>
                        <span class="show active">请选择</span>
                    </div>
                </div>
            </div>
        </div>

        <!--错误提示-->
        <div class="remind_delivery_bg">
            <div class="remind_delivery_cont">
                <p></p>
            </div>
        </div>
        <!--错误提示end-->
        <!--确认提示-->
        <div class="popup_bg">
            <div class="popup_content">
                <div class="popup_title"></div>
                <div class="popup_font"></div>
                <div class="popup_but">
                    <a class="btn-normal cancel" href="javascript:void(0);">取 消</a>
                    <a class="btn-normal btn-normal-confirm confirm" href="javascript:void(0);">确 认</a>
                </div>
            </div>
        </div>
        <!--确认提示end-->
    </div>
	
	<div id="add-price-ticket" class="add-price-ticket hide">
		<div>
			<!--start of  可使用优惠券-->
			<div class="can-use-ticket">
				<div class="list-title">可使用优惠券(<span class="js-available-num">0</span>张)</div>
				<dl class="ticket-list js-coupon-available">
					<!-- <dd class="ticket-item can-use">
						<div class="ticket-info">
							<div class="ticket-value">60</div>
							<div class="ticket-desc">
								<label>加价券</label>
								<span class="condition">满1000元使用</span>
							</div>
						</div>
						<div class="ticket-date">
							<label>有效期:</label>
							<span class="start-date">2018-08-09</span>至<span class="end-date">2019-08-09</span>
						</div>
					</dd>
					<dd class="ticket-item can-use default">
						<div class="ticket-info">
							<div class="ticket-value">50</div>
							<div class="ticket-desc">
								<label>加价券</label>
								<span class="condition">满500元使用</span>
							</div>
						</div>
						<div class="ticket-date">
							<label>有效期:</label>
							<span class="start-date">2018-08-09</span>至<span class="end-date">2019-08-09</span>
						</div>
					</dd>
					<dd class="ticket-item can-use">
						<div class="ticket-info">
							<div class="ticket-value">10<span class="percent-label">%</span></div>
							<div class="ticket-desc">
								<label>加价券</label>
								<span class="condition">满100元使用</span>
							</div>
						</div>
						<div class="ticket-date">
							<label>有效期:</label>
							<span class="start-date">2018-08-09</span>至<span class="end-date">2019-08-09</span>
						</div>
					</dd> -->
				</dl>
			</div>
			<!--end of  可使用优惠券-->
			<!--start of  不可使用优惠券-->
			<div class="cant-use-ticket">
				<div class="list-title">不可使用优惠券(<span class="js-not-available-num">0</span>张)</div>
				<dl class="ticket-list js-coupon-not-available">
					<!-- <dd class="ticket-item used">
						<div class="ticket-info">
							<div class="ticket-value">50</div>
							<div class="ticket-desc">
								<label>加价券</label>
								<span class="condition">满500元使用</span>
							</div>
						</div>
						<div class="ticket-date">
							<label>有效期:</label>
							<span class="start-date">2018-08-09</span>至<span class="end-date">2019-08-09</span>
						</div>
					</dd> -->
				</dl>
			</div>
			<!--end of  不可使用优惠券-->		
		</div>
    </div>
	
	<script src="js/jquery.js"></script>
    <script src="js/common.js"></script>
    <script src="js/address.js"></script>
    <script src="js/jbase64.js"></script>

    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.8&key=0db9bfb678ada40b29eb757e132f63f1"></script>
    <script src="js/location.js"></script>
    <script>
        $(function(){
            getAddr();

            var isGo = eCacheUtil.storage.getCache(CacheKey.happyGo);
            var tip = GetQueryString('tip');
            var fm = eCacheUtil.storage.getCache(CacheKey.source);

            if(isEmpty(fm)){
                eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
            }
            if(isGo == 'true'||tip == 1){
                document.title = '天翼回收';
            }else{
                document.title = '超人回收';
            }
			
			eCacheUtil.storage.cache(CacheKey.HappyGoMobile,"18106538281");
			if(eCacheUtil.storage.getCache(CacheKey.HappyGoMobile)){
			  getIsUserCouponList(eCacheUtil.storage.getCache(CacheKey.HappyGoMobile));
			}
			
			//判断用户的页面来源
            init();
            var num = 0;
            $('#pickTime').click(function () {
                if (num == 0){
                    num = 1;
                    date();
                    $('.timeLeft ul li,.timeRight ul li').eq(0).addClass('active');
                }
                $('#layer').show();
                $('#layer .layerCont').animate({
                    top:"50%"
                },300);
            });
            $('.timeLeft').on('click','li',function () {
                $(this).addClass('active').siblings().removeClass('active');
                var html = $(this).html();
                tabTime(html.substring(html.indexOf('月')+1,html.indexOf('日')));
            });
            $('.timeRight').on('click','li',function () {
                var obj = $('.timeLeft li.active').html();
                $(this).addClass('active').siblings().removeClass('active');
                $('#pickTime p').eq(1).html(obj+' '+$(this).html());
                $('#pickTime').addClass('active');
                $('#layer').hide();
                $('#layer .layerCont').animate({
                    top:"100%"
                });
            });

            $('.recycleWay .label').click(function(){
                if ($(this).find('input').is(':checked')){
                    $('.notice div').removeClass('active');
                    var className = $(this).attr('data-way');
                    $('.'+className).show().siblings().hide();
                    $('.'+className+'1').addClass('active');
                }
            });
            $('label[data-way="postText"]').click(function(){
                if ($('input[name="post"]:checked').val() == 1){
                    init();
                }else{
                    $('#pickTime p').eq(1).html('一小时以内<img src="img/icon_arrow.png" alt="">');
                    $('#pickTime').removeClass('active');
                }
            });

            var checkSubmitFlg = false;
            $('#submit').click(function(){
                if (isEmpty($('#connect').val())){
                    alertTip('请输入联系人');
                    return false;
                }else if (isEmpty($('#inputtel').val())){
                    alertTip('请输入手机号');
                    return false;
                }else if (!$('#selectAddress').hasClass('active')){
                    alertTip('请选择所在地区');
                    return false;
                }else if (isEmpty($('#address').val())){
                    alertTip('请输入详细地址');
                    return false;
                }else if (isEmpty($('#alipay'+$('input:radio[name="way"]:checked').val()).val())){
                    if ($('input:radio[name="way"]:checked').val() == 1){
                        alertTip('请输入支付宝账号');
                        return false;
                    }else{
                        alertTip('请输入手机充值号码');
                        return false;
                    }
                }else if (checkSubmitFlg == true){
                    return false;
                }
                
                checkSubmitFlg = true;
                var base = new Base64(),
                    take_time = '';
                    mailType = $('input:radio[name="post"]:checked').val();
					
					
                    if (mailType == 2){
                        take_time = '';
                    }else{
                        var str = $('#pickTime.active p').eq(1).html();
						
						var    reg = /\(([^()]+)\)/g,
								res = str.match(reg);
							take_time = str.replace(res," ");
                    }
					
					
                var params = {
                    quoteId:base.decode(eCacheUtil.storage.getCache(CacheKey.quoteId)),
                    customerName:$('#connect').val(),
                    mobile:$('#inputtel').val(),
                    province:$('#s_Province').attr('data-id'),
                    city:$('#s_City').attr('data-id'),
                    area:$('#s_County').attr('data-id'),
                    address:$('#address').val(),
                    recycleType:$('input:radio[name="way"]:checked').val(),
                    payMobile:$('#alipay'+$('input:radio[name="way"]:checked').val()).val(),
                    imagePath:eCacheUtil.storage.getCache(CacheKey.imgHref),
                    detail:eCacheUtil.storage.getCache(CacheKey.itemsName),
                    mailType:mailType,
                    takeTime:take_time,
                    fm:eCacheUtil.storage.getCache(CacheKey.source),
                    note:$('#note').val(),
					couponCode:G.defaultCoupon.couponCode || ''
					
                }
				$.post(linkUrl+'/recycleNew/wechatCreateOrder.do',{params:JSON.stringify(params)},
				      function(data){
                        if (data.success){
                            eCacheUtil.storage.cache(CacheKey.orderId,data.result.datainfo.orderid);
                            if(mailType == 2){
                                eCacheUtil.storage.cache(CacheKey.mailType,mailType);
                            }else{
                                eCacheUtil.storage.cache(CacheKey.pickTime,$('#pickTime.active p').eq(1).html());
                            }
							var fm =eCacheUtil.storage.getCache(CacheKey.source);
							//if(fm == '7'){
							 //  createIncreaseOrder(data.result.datainfo.orderid);
							//}else{
							//   location.href = 'success.html';
							//}
							
							 location.href = 'success.html';
                        }else{
                            checkSubmitFlg = false;
                            alertTip(data.resultMessage);
                        }
                    })//
            })

            //加价券 跳转到addPriceTicket.html
            $('.js-ticket-btn').on('click',function(){
                //location.href = 'addPriceTicket.html';
				initAddpricePage();
				$('#add-price-ticket').removeClass( 'hide' );
				return ;
            })
        })
		
		//创建抬价订单
		function createIncreaseOrder(orderNo){
		  var params = {
                orderNo:orderNo
            }
			$.post(linkUrl+'/recycleNew/createIncreaseOrder.do',{params:JSON.stringify(params)},function (data) {
            	if ( data.success){
					eCacheUtil.storage.cache(CacheKey.raiseOrderNo,data.result.increaseOrderNo);
					location.href = 'success.html';
				}else{
					alert(data.resultMessage);
				}
            });
		}
		
		//1.5.12查询所有可用加价券
	    function getIsUserCouponList(mobile){

            //测试用， 设置默认价格
            // eCacheUtil.storage.cache(CacheKey.prePrice,"200");

            //获取手机的估价
            var MP = eCacheUtil.storage.getCache( CacheKey.prePrice );

            var params = {
                mobile:mobile
            }
            $.post(linkUrl+'/recycle/getIsUserCouponList.do',{params:JSON.stringify(params)},function (data) {
                if ( data.success){
                    var coupons = data.result.Coupons;
                    var couponsNum = 0;          // 可用优惠券数量
                    var couponsUsableArr = [];   // 可用
                    var couponsNotUsableArr = [];// 不可用

                    //区分 可用券or不可用券
                    for( var i = 0; i < coupons.length; i++ ){
                        if( MP >= coupons[i].subtractionPrice ){
                            couponsNum++;
                            couponsUsableArr.push( coupons[i] )
                        }else{
                            couponsNotUsableArr.push( coupons[i] )
                        }
                    }

                    //缓存可用优惠券，不可用优惠券
                    eCacheUtil.storage.cache(CacheKey.CouponsAvailable, couponsUsableArr);
                    eCacheUtil.storage.cache(CacheKey.CouponNotAvailable, couponsNotUsableArr);

                    // 计算可用券的优惠价格
                    var couponsPriceFirstArr = [];

                    for( var j = 0; j < couponsUsableArr.length; j++ ){
                        var couponPrice = couponsUsableArr[j].couponPrice;
                        var obj = {};
                        if( couponsUsableArr[j].couponPrice.indexOf('%') != -1 ){
                            obj = {
                                couponPrice: Number(MP * couponsUsableArr[j].couponPrice.replace('%','') / 100 ),
                                endTime: couponsUsableArr[j].endTime,
                                couponCode: couponsUsableArr[j].couponCode
                            }
                        }else {
                            obj = {
                                couponPrice: Number(couponsUsableArr[j].couponPrice.replace('元','')),
                                endTime: couponsUsableArr[j].endTime,
                                couponCode: couponsUsableArr[j].couponCode
                            }
                        }
                        couponsPriceFirstArr.push( obj )
                    }

                    //根据价格由大到小排序
                    var couponsPriceSecondArr = couponsPriceFirstArr.sort(function (a, b) {
                        var val1 = a.couponPrice;
                        var val2 = b.couponPrice;
                        if (val1 > val2) {
                            return -1;
                        } else if (val1 < val2) {
                            return 1;
                        } else {
                            return 0;
                        }            
                    })

                    //比较是否有最低优惠价格相同的券，如果有比较日期
                    //确认使用哪一张优惠券
                    var couponsPriceThirdArr = [];
                    var bestPrice = couponsPriceSecondArr[0] ? couponsPriceSecondArr[0].couponPrice : 0;
                    for( var i = 0; i < couponsPriceSecondArr.length; i++ ){
                        if( bestPrice == couponsPriceSecondArr[i].couponPrice ){
                            couponsPriceThirdArr.push( couponsPriceSecondArr[i] )
                        }
                    };

                    // 最优惠券按照过期时间排序
                    couponsPriceFourthArr = couponsPriceThirdArr.sort(function (a, b) {
                        var val1 = a.endTime;
                        var val2 = b.endTime;
                        if (val1 < val2) {
                            return -1;
                        } else if (val1 > val2) {
                            return 1;
                        } else {
                            return 0;
                        }            
                    });

                    // 渲染页面 ，判断是否有默认优惠券，没有就渲染之前的bestPrice
                    $('.js-all-coupons i').text( couponsNum );
                    if( eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ) ){
                        var couponsAvailableDefault = JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ));
                    }else{
                        var couponsAvailableDefault = {}                       
                    }

                    if( couponsAvailableDefault.couponPrice ){
                        if( couponsAvailableDefault.couponPrice.indexOf('%') != -1 ){
                            $('.js-current-coupons i').text( MP * couponsAvailableDefault.couponPrice.replace('%','') / 100 );
                        }else {
                            $('.js-current-coupons i').text( couponsAvailableDefault.couponPrice.replace('元','') );
                        }
                    }else{
                        $('.js-current-coupons i').text( bestPrice );

                        //缓存默认优惠券
                        eCacheUtil.storage.cache(CacheKey.CouponsAvailableDefault, couponsPriceFourthArr[0]);
                    }
                }else{
                    alert(data.resultMessage);
                }
            });
		}
		
        function fn_close(ele){
            $('#'+ele).hide().find('.layerCont').css({top:'100%'});
        }

        function init(){
            date();
            $('#pickTime p').eq(1).html($('.timeLeft li.active').html()+' '+$('.timeRight li.active').html());
            $('#pickTime').addClass('active');
        }

        function date() {
            var myDate = new Date(),
                year = myDate.getFullYear(),//年
                month = myDate.getMonth() + 1,//月
                day = myDate.getDate(),//日
                week = myDate.getDay(),//星期几
                hour = myDate.getHours();//时

            var s = '',
                weekArr = ['今天','明天',weekText(week+2),weekText(week+3),weekText(week+4),weekText(week+5),weekText(week+6),weekText(week+7)],
                index = 0;
            if ((hour+1) >= 17){
                day += 1;
                index = 1;
            }
            tabTime(day);
            for (var i = 0;i < 7;i++){
                if (day > getlastday(year,month)){
                    month += 1;
                    day = 1;
                }
                s += '<li>'+month+'月'+day+'日('+weekArr[index]+')</li>';
                day++;
                index++;
            }
            $('.timeLeft ul').html(s);
            $('.timeLeft ul').find('li').eq(0).addClass('active');
        }

        function tabTime(day) {
            var date = new Date(),
                hour = date.getHours();
            if (day == date.getDate()){//从今天
                var s = '<ul>';
                for (var i = (hour+1);i < 17;i++){
                    s += '<li>'+i+':00-'+(i+1)+':00</li>';
                }
                $(".timeRight").html(s+'</ul>');
            }else {//非今天
                var tmp = $("#template").clone();
                tmp.removeAttr("id");
                //追加到对应区块
                $(".timeRight").html(tmp.html());
            }
            $(".timeRight").find('li').eq(0).addClass('active');
        }

        function weekText(week) {
            if (week > 7){
                week -= 7;
            }
            switch (week){
                case 1:
                    return '星期一';
                break;
                case 2:
                    return "星期二";
                    break;
                case 3:
                    return "星期三";
                    break;
                case 4:
                    return "星期四";
                    break;
                case 5:
                    return "星期五";
                    break;
                case 6:
                    return "星期六";
                    break;
                case 7:
                    return "星期日";
                    break;
            }
        }
		
		window.G = window.G || {};
		function initAddpricePage(){
			//G.couponsUsableArr = JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponsAvailable ) );
			//G.couponsNotUsableArr = JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponNotAvailable ) );
			//G.couponsAvailableDefault = JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ) );
			
			G.couponsUsableArr = eCacheUtil.storage.getCache( CacheKey.CouponsAvailable ) ? JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponsAvailable ) ) : {};
			G.couponsNotUsableArr = eCacheUtil.storage.getCache( CacheKey.CouponNotAvailable ) ? JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponNotAvailable ) ) : {}; 
			G.couponsAvailableDefault = eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ) ? JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ) ) : {};


			// 可用不可用优惠券的数量
			$('.js-available-num').text( G.couponsUsableArr.length )
			$('.js-not-available-num').text( G.couponsNotUsableArr.length )

			// 可用优惠券
			var couponAvailableHTML = ''
			for( var i = 0; i < G.couponsUsableArr.length; i++ ){
				var classHtml = '';
				// 判断是否是默认优惠券
				if( G.couponsUsableArr[i].couponCode == G.couponsAvailableDefault.couponCode ){
					classHtml = '<dd class="ticket-item can-use default" data-code="'+ G.couponsUsableArr[i].couponCode +'">';
				}else{
					classHtml = '<dd class="ticket-item can-use" data-code="'+ G.couponsUsableArr[i].couponCode +'">'
				}

				couponAvailableHTML+=   classHtml+
					'	<div class="ticket-info">'+
					'		<div class="ticket-value">'+ G.couponsUsableArr[i].couponPrice.replace('元','') +'</div>'+
					'		<div class="ticket-desc">'+
					'			<label>加价券</label>'+
					'			<span class="condition">满'+ G.couponsUsableArr[i].subtractionPrice +'元使用</span>'+
					'		</div>'+
					'	</div>'+
					'	<div class="ticket-date">'+
					'		<label>有效期:</label>'+
					'		<span class="start-date">'+ G.couponsUsableArr[i].beginTime +'</span>至<span class="end-date">'+ G.couponsUsableArr[i].endTime +'</span>'+
					'	</div>'+
					'</dd>'
			}
			$('.js-coupon-available').html( couponAvailableHTML );

			// 不可用优惠券
			var couponNotAvailableHTML = ''
			for( var i = 0; i < G.couponsNotUsableArr.length; i++ ){
				couponNotAvailableHTML+=   '<dd class="ticket-item used" data-code="'+ G.couponsNotUsableArr[i].couponCode +'">'+
					'	<div class="ticket-info">'+
					'		<div class="ticket-value">'+ G.couponsNotUsableArr[i].couponPrice.replace('元','') +'</div>'+
					'		<div class="ticket-desc">'+
					'			<label>加价券</label>'+
					'			<span class="condition">满'+ G.couponsNotUsableArr[i].subtractionPrice +'元使用</span>'+
					'		</div>'+
					'	</div>'+
					'	<div class="ticket-date">'+
					'		<label>有效期:</label>'+
					'		<span class="start-date">'+ G.couponsNotUsableArr[i].beginTime +'</span>至<span class="end-date">'+ G.couponsNotUsableArr[i].endTime +'</span>'+
					'	</div>'+
					'</dd>'
			}
			$('.js-coupon-not-available').html( couponNotAvailableHTML );

		}
		
		//切换优惠券
		$('.js-coupon-available').delegate( '.ticket-item' , 'click' , function(){
			//获取手机的估价
            var MP = eCacheUtil.storage.getCache( CacheKey.prePrice );
			
			//缓存默认优惠券
			for(var i = 0; i < G.couponsUsableArr.length; i++){
				if( $(this).data('code') == G.couponsUsableArr[i].couponCode ){
					eCacheUtil.storage.cache(CacheKey.CouponsAvailableDefault, G.couponsUsableArr[i]);
				}
			}

			//跳转页面
			//location.href = 'order.html';
			//刷新页面内容 
			if( eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ) ){
                var couponsAvailableDefault = JSON.parse( eCacheUtil.storage.getCache( CacheKey.CouponsAvailableDefault ));
				G.defaultCoupon = couponsAvailableDefault ;
			}else{
				var couponsAvailableDefault = {}   
				G.defaultCoupon = couponsAvailableDefault ;
			}

			if( couponsAvailableDefault.couponPrice ){
				if( couponsAvailableDefault.couponPrice.indexOf('%') != -1 ){
					$('.js-current-coupons i').text( MP * couponsAvailableDefault.couponPrice.replace('%','') / 100 );
				}else {
					$('.js-current-coupons i').text( couponsAvailableDefault.couponPrice.replace('元','') );
				}
			}else{
				$('.js-current-coupons i').text( bestPrice );
			}
			
			//关闭选择框
			$('#add-price-ticket').addClass( 'hide' );
		});
		
		//初始化优惠券列表
		initAddpricePage();
    </script>
<!--站长统计-->
<div style="display: none;">
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261469862'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1261469862%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
</body>
</html>