<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="js/flexible.js"></script>
	<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
    <link rel="stylesheet" href="css/main.css?version=1.6">
    <link rel="stylesheet" href="css/addPriceTicket.css">
    <title></title>
    <style>
        #wrap.resultWrap .main .mixinsBox {
            height: auto;
            width: 100%;
            position: fixed;
            left: 0;
            bottom: 0;
            padding: 0 !important;
            /*margin-bottom: 5px;*/
        }

        .btn-disabled {
            background-color: #969696;
        }

        .sale {
            font-style: normal;
        }

        .price-tip i {
            font-style: normal;
        }

		#wrap>#main-box {
          overflow: auto;
        }
        #wrap.orderWrap .main .ticket .ticket-box {
            justify-content: space-between;
            margin-top: 0;
            color: red;
        }

        #wrap.orderWrap .main .ticket .ticket-box i {
            font-style: normal;
        }

        .all-coupons  {
            position: relative;
            padding-right: 0.15rem;
        }

        .all-coupons p {
            position: absolute;
            right: 0;
            top: 2px;
        }

        .all-coupons p img {
            display: block;
            width: .06rem;
        }
    </style>
</head>
<body>
    <div id='map-container'></div>

    <div id="wrap" class="resultWrap orderWrap">
        <div class="pageTitle">
            <a href="javascript:window.history.back();">
                <img src="img/icon_arrow.png" alt="">
            </a>
            <h3></h3>
        </div>
        <div class="main">
            <div class="estimatePrice">
                <!--<p>您的宝贝预估可卖</p>-->
                <p class="pricePre"><img src="img/loadings.gif" alt=""></p>
                <p class="ping2">
                    <span></span>预计一周后降价<i class="sale"></i>元

                    <button id="restart">重新估价</button>
                </p>
                <p class="price-tip" id="showLogin" style="display: none">
                    点击登录，立即加价
                </p>
                <p class="price-tip"  id="addInfo"  style="display: none">
                    <span></span><label id="disTip">加价 (30分钟内下单有效)</label>
                </p>
              <!--  <p class="ping1"><a href="javascript:;" onclick="Reassess();">重新评估</a></p>   -->

            </div>
            <div class="mixinsBox">
                <div class="exchangeBox">
                    <p>合计：￥<span  class="price"><img src="img/loadings.gif" alt=""></span></p>
                    <a href="javascript:;" id="nowChange" >立即回收</a>
                </div>
            </div>

            <!-- ********** -->
            <div class="postInfo">
                <div class="postway">
                    <label class="label" data-way="postText">
                        <span class="genre">顺丰上门回收</span>
                        <img  src="img/free.png" alt="">
                    </label>
                    <div id="pickTime" >
                        <p style="display: none"><img style="width: 0.1rem" src="img/icon_arrow.png" alt=""></p>
                        <p></p>
                        <p><img style="width: 0.1rem" src="img/icon_arrow.png" alt=""></p>
                    </div>
                </div>
            </div>
            <div class="addressInfo">
                <div id="selectAddress" class="eachRow">
                    <p class="default-addr">所在地区</p>
                    <p><img src="img/icon_arrow.png" alt=""></p>
                </div>
                <div class="inputRow">
                    <input class="text mustText" id="address" maxlength="64" type="text" value="" placeholder="街道、小区门牌等详细地址">
                </div>
            </div>
            <div class="baseInfo">
                <div class="inputRow">
                    <!--<p>联系人</p>-->
                    <input type="text" name="" id="connect" maxlength="12" placeholder="请输入寄件人真实姓名">
                </div>
                <div class="inputRow">
                    <p id="phoneTip" style="display: none">取件手机号</p>
                    <input class="text" id="inputtel" type="tel" value="" maxlength="11" placeholder="请输入寄件人手机号" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')" />
                </div>
            </div>


            <div class="recycleWay" style="margin-top: 0.1rem">
                <!--<p class="moduleTitle">收款方式</p>-->

                <div class="eachRow">
				    <span class="title">结款方式：</span>
					 <label class="label" data-way="alipayText">
                        <input name="way"  checked="checked" type="radio" value="1" />
                        <i class="radio_icon"></i>
                        <span class="genre">支付宝付款</span>
                    </label>
                    <label class="label" data-way="phoneText">
                        <input  name="way" type="radio" value="2" />
                        <i class="radio_icon"></i>
                        <span class="genre">话费充值</span>
                        <img src="img/icon_hot.png" alt="">
                    </label>

                </div>
                <div class="inputRow" id="alipayBox">
                    <input id="alipay2" class="text mustText phoneText" data-way="call" style="display:none;" maxlength="11"  type="text" value="" placeholder="请输入手机充值号码" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')">

                    <input id="alipay1" class="text mustText alipayText" data-way="alipay"  type="text" value="" placeholder="请输入支付宝账号">

                </div>
            </div>
            <!--<div class="ticket">-->
                 <!--&lt;!&ndash;<p class="moduleTitle">加价券</p>&ndash;&gt;-->
                 <!--<div class="ticket-box">-->
                    <!--<input id="ticket-text" type="text" value="" placeholder="请输入加价券码">-->
                 <!--</div>-->
            <!--</div>-->

            <div class="ticket">
                <p class="moduleTitle">加价券</p>
                <div class="ticket-box js-ticket-btn">
                    <span class="js-current-coupons">
                        加价:
                        <i>0</i>
                        元
                    </span>
                    <span class="all-coupons js-all-coupons">
                        还有
                        <i>0</i>
                        张可用
                        <p><img src="img/icon_arrow.png" alt=""></p>
                    </span>
                    <!-- <input id="ticket-text" type="text" value="" placeholder="请输入加价券码"> -->
                </div>
            </div>

            <div class="mailing_addr">
                <label id="isAgreen">
                    <span class="active"></span>
                    我已阅读并同意<a href="./agreement.html">用户协议</a>，并确认机器来源合法
                </label>
            </div>
        </div>

        <!-- 取件时间layer -->
        <div id="layer">
            <div class="layerCont">
                <div class="layerTitle">
                    <p>选择上门取件时间</p>
                    <a href="javascript:;" class="cancel" onclick="fn_close('layer')">×</a>
                </div>
                <div class="selTime clearfix">
                    <div class="timeLeft fl">
                        <ul>
                        </ul>
                    </div>
                    <div class="timeRight fl">
                    </div>
                </div>
            </div>
            <div id="template" style="display: none;">
                <ul>
                    <li>9:00-10:00</li>
                    <li>10:00-11:00</li>
                    <li>11:00-12:00</li>
                    <li>12:00-13:00</li>
                    <li>13:00-14:00</li>
                    <li>14:00-15:00</li>
                    <li>15:00-16:00</li>
                    <li>16:00-17:00</li>
                </ul>
            </div>
        </div>
        <!-- 选择地区layer -->
        <div id="addrLayer">
            <div class="layerCont">
                <div class="layerTitle">
                    <p>所选地区</p>
                    <a href="javascript:;" class="cancel" onclick="fn_close('addrLayer')">×</a>
                </div>
                <div class="selectAddr">
                    <div id="selected">
                        <span id="s_Province"></span>
                        <span id="s_City"></span>
                        <span id="s_County"></span>
                        <span class="show active">请选择</span>
                    </div>
                </div>
            </div>
        </div>

        <!--错误提示-->
        <div class="remind_delivery_bg">
            <div class="remind_delivery_cont">
                <p></p>
            </div>
        </div>
        <!--错误提示end-->
        <!--确认提示-->
        <div class="popup_bg">
            <div class="popup_content">
                <div class="popup_title"></div>
                <div class="popup_font"></div>
                <div class="popup_but">
                    <a class="btn-normal cancel" href="javascript:void(0);">取 消</a>
                    <a class="btn-normal btn-normal-confirm confirm" href="javascript:void(0);">确 认</a>
                </div>
            </div>
        </div>
        <!--确认提示end-->

        <!--start of 弹出对话框-->
        <div id="popoDialog" class="popo-dialog hide">
            <div id="phone-dialog-box" class="dialog-box">
                <div class="dialog-title">登录</div>
                <div class="dialog-body">
                    <div class="input-item">
                        <input id="phoneNum" class="popodlg-input"  type="text" placeholder="请输入登录手机号码" />
                    </div>
                    <div class="input-item">
                        <input id="codeNum"   class="short-input popodlg-input" type="text" placeholder="请填写验证码" />
                        <span id="getCodeBtn" class="input-label active-btn">获取验证码</span>
                        <!--<span id="secondLabel" class="input-label info-box">60秒</span>-->
                    </div>
                    <div class="input-item">
                        <span id="doPrizeBtn" class="do-prize-btn">立刻登录</span>
                    </div>
                </div>
                <span id="closePopoDialogBtn" class="close-btn">X</span>
            </div>
        </div>
        <!--end of 弹出对话框-->

        <div id="add-price-ticket" class="add-price-ticket hide">
            <div>
                <!--start of  可使用优惠券-->
                <div class="can-use-ticket">
                    <div class="list-title">可使用优惠券(<span class="js-available-num">0</span>张)</div>
                    <dl class="ticket-list js-coupon-available">
                    </dl>
                </div>
                <!--end of  可使用优惠券-->
                <!--start of  不可使用优惠券-->
                <div class="cant-use-ticket">
                    <div class="list-title">不可使用优惠券(<span class="js-not-available-num">0</span>张)</div>
                    <dl class="ticket-list js-coupon-not-available">
                    </dl>
                </div>
                <!--end of  不可使用优惠券-->
            </div>
        </div>
    </div>


    <!--
	 <div onclick="go_view();">
		<a href="javascript:;" class="btn-large">打开小程序</a>
	 </div>
	 -->
    <script src="js/jquery.js"></script>
    <script src="js/jbase64.js"></script>
    <script src="js/common.js"></script>
	<script src="js/util.js"></script>
    <script src="js/address.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.8&key=0db9bfb678ada40b29eb757e132f63f1"></script>
    <script src="js/location.js"></script>

	<script>
		function getUrlParam(key){
			var url = window.location.search;
			var reg = new RegExp("(^|&)"+ key +"=([^&]*)(&|$)");
			var result = url.substr(1).match(reg);
			return result ? decodeURIComponent(result[2]) : null;
		}

		function setCacheData(key,keyName){
			if(getUrlParam(keyName)!==null &&  getUrlParam(keyName) !== undefined && getUrlParam(keyName)!==''){
			  eCacheUtil.storage.cache(key,getUrlParam(keyName));
			}
		}

		if (getUrlParam("productid")){
		    setCacheData(CacheKey.SelectItems,"SelectItems");
			setCacheData(CacheKey.ProjectId,"productid");
			setCacheData(CacheKey.OpenId,"openId");
			setCacheData(CacheKey.ModelName,"modelName");
			setCacheData(CacheKey.ModelCode,"modelCode");
			setCacheData(CacheKey.imgHref,"modelImageUrl");
			setCacheData(CacheKey.LastPrice,"lastPrice");
			setCacheData(CacheKey.source,"fm");
			eCacheUtil.storage.cache(CacheKey.isSelect,false);
		}
    </script>

    <script>
        $(function(){
            var isGo = eCacheUtil.storage.getCache(CacheKey.happyGo);
            var tip = GetQueryString('tip');
            var fm = eCacheUtil.storage.getCache(CacheKey.source);

            if(isEmpty(fm)){
                eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
            }
            if(fm == 2 || fm == 9 || fm == 10){
				document.title = '天翼回收';
			}else{
				document.title = '翼回收';
			}

			var HappyGoMobile=eCacheUtil.storage.getCache(CacheKey.HappyGoMobile);
            $('h3').html(eCacheUtil.storage.getCache(CacheKey.ModelName));

            //判断是否为小程序来源
            var openId=eCacheUtil.storage.getCache(CacheKey.OpenId);
            if(isEmpty(openId)){
                openId = '';
            }
            var checkSubmitFlg = false;


            $('#nowChange').click(function(){
                if( $(this).hasClass('btn-disabled') ){
                    return;
                }
                if (!$('#selectAddress').hasClass('active')){
                    alertTip('请选择所在地区');
                    return false;
                }else if (isEmpty($('#address').val())){
                    alertTip('请输入详细地址');
                    return false;
                } if (isEmpty($('#connect').val())){
                    alertTip('请输入寄件人真实姓名');
                    return false;
                }else if (isEmpty($('#inputtel').val())){
                    alertTip('请输入寄件人手机号');
                    return false;
                }else if (isEmpty($('#alipay'+$('input:radio[name="way"]:checked').val()).val())){
                    if ($('input:radio[name="way"]:checked').val() == 1){
                        alertTip('请输入支付宝账号');
                        return false;
                    }else{
                        alertTip('请输入手机充值号码');
                        return false;
                    }
                }else if(!$("#isAgreen").find("span").hasClass('active')){
                    alertTip('请阅读用户协议');
                    return false;
                }else if (checkSubmitFlg == true){
                    return false;
                }

                checkSubmitFlg = true;
                var base = new Base64(),
                    take_time = '';
                    mailType = $('input:radio[name="post"]:checked').val();
                    if (mailType == 2){
                        take_time = '';
                    }else{
                        var str = $('#pickTime.active p').eq(1).html(),
                            reg = /\(([^()]+)\)/g,
                            res = str.match(reg);
                        take_time = str.replace(res," ");
                    }
                var phoneNumber = '';
                var loginPhone = eCacheUtil.storage.getCache(CacheKey.loginPhone);
                var HappyGoMobile = eCacheUtil.storage.getCache(CacheKey.HappyGoMobile);
                if(loginPhone || HappyGoMobile) {
                    if (loginPhone) {
                        phoneNumber = loginPhone
                    } else if (HappyGoMobile) {
                        phoneNumber = HappyGoMobile
                    }
                }
                var newId = eCacheUtil.storage.getCache('discount_info_infos');
                    var params = {
                    phone: phoneNumber,
                    quoteId:base.decode(eCacheUtil.storage.getCache(CacheKey.quoteId)),
                    customerName:$('#connect').val(),
                    mobile:$('#inputtel').val(),
                    province:$('#s_Province').attr('data-id'),
                    city:$('#s_City').attr('data-id'),
                    area:$('#s_County').attr('data-id'),
                    address:$('#address').val(),
                    recycleType:$('input:radio[name="way"]:checked').val(),
                    payMobile:$('#alipay'+$('input:radio[name="way"]:checked').val()).val(),
                    imagePath:eCacheUtil.storage.getCache(CacheKey.imgHref),
                    detail:eCacheUtil.storage.getCache(CacheKey.itemsName),
                    mailType:1,
                    takeTime:take_time,
                    fm:eCacheUtil.storage.getCache(CacheKey.source),
                    note:$('#note').val(),
                    couponCode: newId,

                }
                $.post(linkUrl+'/recycleNew/wechatCreateOrder.do',{params:JSON.stringify(params)},
                      function(data){
                        if (data.success){
                            eCacheUtil.storage.cache(CacheKey.orderId,data.result.datainfo.orderid);
                            if(mailType == 2){
                                eCacheUtil.storage.cache(CacheKey.mailType,mailType);
                            }else{
                                eCacheUtil.storage.cache(CacheKey.pickTime,$('#pickTime.active p').eq(1).html());
                            }
                            var fm =eCacheUtil.storage.getCache(CacheKey.source);
                            //if(fm == '7'){
                             //  createIncreaseOrder(data.result.datainfo.orderid);
                            //}else{
                            //   location.href = 'success.html';
                            //}

                             location.href = 'success.html?id='+data.result.datainfo.orderid;
                        }else{
                            checkSubmitFlg = false;
                            alertTip(data.resultMessage);
                        }
                    })//
            })
        })
        function Reassess() {
            eCacheUtil.storage.cache(CacheKey.isSelect,false);
            eCacheUtil.storage.removeCache(CacheKey.prePrice);
            location.href = 'test.html';
        }


		function go_view(){
	     var prePrice = eCacheUtil.storage.getCache(CacheKey.prePrice);
		 var quote = eCacheUtil.storage.getCache(CacheKey.quoteId);
		 var SelectItems = eCacheUtil.storage.getCache(CacheKey.SelectItems);
		 var productid=eCacheUtil.storage.getCache(CacheKey.ProjectId);
		 var isSelect=eCacheUtil.storage.getCache(CacheKey.isSelect);

		 var val="prePrice="+prePrice+"&quote="+quote+"&SelectItems="+SelectItems+"&productid="+productid+"&isSelect="+isSelect;
		 var val="SelectItems="+SelectItems+"&productid="+productid+"&isSelect=true";

		  wx.miniProgram.reLaunch({url:'/pages/share/share'});
		  wx.miniProgram.postMessage({ data: {val:val} });
		}
    </script>

    <script>
        $(function(){


            getAddr();

            var isGo = eCacheUtil.storage.getCache(CacheKey.happyGo);
            var tip = GetQueryString('tip');
            var fm = eCacheUtil.storage.getCache(CacheKey.source);

            var mobileNum = eCacheUtil.storage.getCache(CacheKey.HappyGoMobile );
            $("#phoneTip").show();
            $('#inputtel').val( mobileNum );

            if(isEmpty(fm)){
                eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
            }
            if(fm == 2 || fm == 9 || fm == 10){
                document.title = '天翼回收';
            }else{
                document.title = '翼回收';
            }
            init();
            var num = 0;
            $('#pickTime').click(function () {
                if (num == 0){
                    num = 1;
                    date();
                    $('.timeLeft ul li,.timeRight ul li').eq(0).addClass('active');
                }
                $('#layer').show();
                $('#layer .layerCont').animate({
                    top:"50%"
                },300);
            });
            $('.timeLeft').on('click','li',function () {
                $(this).addClass('active').siblings().removeClass('active');
                var html = $(this).html();
                tabTime(html.substring(html.indexOf('月')+1,html.indexOf('日')));
            });
            $('.timeRight').on('click','li',function () {
                var obj = $('.timeLeft li.active').html();
                $(this).addClass('active').siblings().removeClass('active');
                $('#pickTime p').eq(1).html(obj+' '+$(this).html());
                $('#pickTime').addClass('active');
                $('#layer').hide();
                $('#layer .layerCont').animate({
                    top:"100%"
                });
            });

            $('.recycleWay .label').click(function(){
                if ($(this).find('input').is(':checked')){
                    $('.notice div').removeClass('active');
                    var className = $(this).attr('data-way');
                    $('.'+className).show().siblings().hide();
                    $('.'+className+'1').addClass('active');
                }
            });
            $('label[data-way="postText"]').click(function(){
                if ($('input[name="post"]:checked').val() == 1){
                    init();
                }else{
                    $('#pickTime p').eq(1).html('一小时以内');
                    $('#pickTime').removeClass('active');
                }
            });

        //    重新评估
            $("#restart").on('click',function () {
                eCacheUtil.storage.cache(CacheKey.isSelect,false);
                location.href = "test.html";
            })

        //    切换是否同意
            $("#isAgreen").on('click',function () {
                $(this).find('span').toggleClass('active')

            })

        })

        //创建抬价订单
        function createIncreaseOrder(orderNo){
          var params = {
                orderNo:orderNo
            }
            $.post(linkUrl+'/recycleNew/createIncreaseOrder.do',{params:JSON.stringify(params)},function (data) {
                if ( data.success){
                    eCacheUtil.storage.cache(CacheKey.raiseOrderNo,data.result.increaseOrderNo);
                    location.href = 'success.html';
                }else{
                    alert(data.resultMessage);
                }
            });
        }

        function fn_close(ele){
            $('#'+ele).hide().find('.layerCont').css({top:'100%'});
        }

        function init(){
            date();
            $('#pickTime p').eq(1).html($('.timeLeft li.active').html()+' '+$('.timeRight li.active').html());
            $('#pickTime').addClass('active');
        }

        function date() {
            var myDate = new Date(),
                year = myDate.getFullYear(),//年
                month = myDate.getMonth() + 1,//月
                day = myDate.getDate(),//日
                week = myDate.getDay(),//星期几
                hour = myDate.getHours();//时

            var s = '',
                weekArr = ['今天','明天',weekText(week+2),weekText(week+3),weekText(week+4),weekText(week+5),weekText(week+6),weekText(week+7)],
                index = 0;
            if ((hour+1) >= 17){
                day += 1;
                index = 1;
            }
            tabTime(day);
            for (var i = 0;i < 7;i++){
                if (day > getlastday(year,month)){
                    month += 1;
                    day = 1;
                }
                s += '<li>'+month+'月'+day+'日('+weekArr[index]+')</li>';
                day++;
                index++;
            }
            $('.timeLeft ul').html(s);
            $('.timeLeft ul').find('li').eq(0).addClass('active');
        }

        function tabTime(day) {
            var date = new Date(),
                hour = date.getHours();
            if (day == date.getDate()){//从今天
                var s = '<ul>';
                for (var i = (hour+1);i < 17;i++){
                    s += '<li>'+i+':00-'+(i+1)+':00</li>';
                }
                $(".timeRight").html(s+'</ul>');
            }else {//非今天
                var tmp = $("#template").clone();
                tmp.removeAttr("id");
                //追加到对应区块
                $(".timeRight").html(tmp.html());
            }
            $(".timeRight").find('li').eq(0).addClass('active');
        }

        function weekText(week) {
            if (week > 7){
                week -= 7;
            }
            switch (week){
                case 1:
                    return '星期一';
                break;
                case 2:
                    return "星期二";
                    break;
                case 3:
                    return "星期三";
                    break;
                case 4:
                    return "星期四";
                    break;
                case 5:
                    return "星期五";
                    break;
                case 6:
                    return "星期六";
                    break;
                case 7:
                    return "星期日";
                    break;
            }
        }


    </script>

    <script>
        $(function(){
            var G = {}
            var fm = eCacheUtil.storage.getCache(CacheKey.source);

            if(isEmpty(fm)){
                eCacheUtil.storage.cache(CacheKey.source,GetQueryString('fm'));
            }
            if(fm == 2 || fm == 9 || fm == 10){
                document.title = '天翼回收';
            }else{
                document.title = '翼回收';
            }

            var initPhone = '';
            var loginPhone = eCacheUtil.storage.getCache(CacheKey.loginPhone);
            var HappyGoMobile = eCacheUtil.storage.getCache(CacheKey.HappyGoMobile);
            if(loginPhone) {
                initPhone = loginPhone;
            }else if(HappyGoMobile){
                initPhone = HappyGoMobile;
            }
            //初始化价格

            isLoginCheck();
            function initPrice () {
                var newId = eCacheUtil.storage.getCache('discount_info_infos');


                var HappyGoMobile=eCacheUtil.storage.getCache(CacheKey.HappyGoMobile);
                //判断是否为小程序来源
                var openId=eCacheUtil.storage.getCache(CacheKey.OpenId);
                if(isEmpty(openId)){
                    openId = '';
                }

                var prePrice = eCacheUtil.storage.getCache(CacheKey.prePrice),
                    quote = '';

                if (!isEmpty(prePrice)){
                    $('.price').html(prePrice);
                    $('.pricePre').html(prePrice);

                    quote = eCacheUtil.storage.getCache(CacheKey.quoteId);
                }else{
                    var itemsId = eCacheUtil.storage.getCache(CacheKey.SelectItems);
                    var param = {
                        "productid":eCacheUtil.storage.getCache(CacheKey.ProjectId),
                        "items":itemsId,
                        "openId":openId,
                        "loginMobile":HappyGoMobile,
                        "fm": fm
                    },base = new Base64();
                    $.post(linkUrl+'/recycleNew/getPrice.do',{params:JSON.stringify(param)},function (data) {
                        if (data.success){
                            var dataInfo = data.result.datainfo;
                            prePrice = dataInfo.price;

                            $('.pricePre').html(prePrice);
                            eCacheUtil.storage.cache('initPrice',prePrice);
                            $('.price').html(prePrice);

                            if(initPhone) {
                                getIsUserCouponList(initPhone)
                            }else{
                                $('.price').html(prePrice);
                            }

                            /*  if(  prePrice * 0.1 >= 200 ){
                                  $('.price-tip span').text(200);
                                  $('.price').html(prePrice + 200);
                              }else{
                                  $('.price-tip span').text(prePrice*0.1);
                                   $('.price').html(prePrice + prePrice*0.1);
                              }  */
                            $('.ping2 .sale').text( Math.round(prePrice*0.055) );
                            eCacheUtil.storage.cache(CacheKey.PrePrice, prePrice);
                            quote = base.encode(dataInfo.quoteid);
                            eCacheUtil.storage.cache(CacheKey.quoteId,quote);
                            loading_hide();
                        }else {
                            loading_hide();
                            alertTip(data.resultMessage);
                        }
                    });
                }


            }
            //1.5.12查询所有可用加价券

            function getIsUserCouponList(mobile){
                var newId = eCacheUtil.storage.getCache('discount_info_infos');
                //获取手机的估价
                var MP = eCacheUtil.storage.getCache( CacheKey.prePrice );

                var params = {
                    mobile:mobile
                }
                $.post(linkUrl+'/recycle/getAllUserCouponList.do',{params:JSON.stringify(params)},function (data) {
                    if ( data.success && data.result.Coupons){
                        var coupons = data.result.Coupons;
                        var couponsNum = coupons.length;
                        // 可用优惠券数量
                        var prePrice = parseInt(eCacheUtil.storage.getCache('initPrice'))
                        // var couponsUsableArr = coupons;

                        // G.couponsUsableArr = coupons ;

                        var couponsUsableArr = [];   // 可用
                        var couponsNotUsableArr = [];// 不可用

                        //区分 可用券or不可用券
                        for( var i = 0; i < coupons.length; i++ ){
                            if( prePrice >= coupons[i].subtractionPrice ){
                                couponsNum++;
                                couponsUsableArr.push( coupons[i] )
                            }else{
                                couponsNotUsableArr.push( coupons[i] )
                            }
                        }

                        G.couponsUsableArr = couponsUsableArr ;
                        G.couponsNotUsableArr = couponsNotUsableArr ;

                        // 计算可用券的优惠价格
                        var couponsPriceFirstArr = [];
                        // couponType 1 百分比 2 定额


                        for( var j = 0; j < couponsUsableArr.length; j++ ){

                            var obj = calPrice(couponsUsableArr[j]);

                            couponsPriceFirstArr.push( obj )
                        }


                        //根据价格由大到小排序
                        var couponsPriceSecondArr = couponsPriceFirstArr.sort(function (a, b) {
                            var val1 = a.addPrice;
                            var val2 = b.addPrice;
                            if (val1 > val2) {
                                return -1;
                            } else if (val1 < val2) {
                                return 1;
                            } else {
                                return 0;
                            }
                        })

                        //比较是否有最低优惠价格相同的券，如果有比较日期
                        //确认使用哪一张优惠券
                        var couponsPriceThirdArr = [];
                        var bestPrice = couponsPriceSecondArr[0] ? couponsPriceSecondArr[0].addPrice : 0;
                        for( var i = 0; i < couponsPriceSecondArr.length; i++ ){
                            if( bestPrice == couponsPriceSecondArr[i].addPrice ){
                                couponsPriceThirdArr.push( couponsPriceSecondArr[i] )
                            }
                        };

                        // 最优惠券按照过期时间排序
                        couponsPriceFourthArr = couponsPriceThirdArr.sort(function (a, b) {
                            var val1 = a.endTime;
                            var val2 = b.endTime;
                            if (val1 < val2) {
                                return -1;
                            } else if (val1 > val2) {
                                return 1;
                            } else {
                                return 0;
                            }
                        });

                        //couponsPriceFourthArr 是最优优惠券的数组，大部分情况下是1个元素
                        //存在多个元素时，按过期时间排序

                        // 渲染页面 ，判断是否有默认优惠券，没有就渲染之前的bestPrice
                        // 优惠券列表的代码合入order.html后，不需要缓存了
                        if(newId) {
                            // 识别默认优惠券
                            for(var i = 0; i < couponsUsableArr.length; i++){
                                if( newId == couponsUsableArr[i].couponCode ){
                                    //保存默认的优惠券
                                    G.couponsAvailableDefault = couponsUsableArr[i] ;
                                }
                            }

                            if(G.couponsUsableArr.length > 0 || !G.couponsAvailableDefault){
                                $('.js-current-coupons i').text( bestPrice );
                                G.couponsAvailableDefault = couponsPriceFourthArr[0] || {};    //保存默认的优惠券

                            }
                        }else if(G.couponsUsableArr.length > 0 ){
                            $('.js-current-coupons i').text( bestPrice );
                            G.couponsAvailableDefault = couponsPriceFourthArr[0] || {};    //保存默认的优惠券

                        }else {
                            $('.js-current-coupons i').text( 0 );
                            $("#addInfo").hide()
                        }
                        if(G.couponsAvailableDefault ) {
                            $("#disTip").html('加价'+ G.couponsAvailableDefault.present + '元' + "（30分钟内下单有效）")
                            // calPrice(G.couponsAvailableDefault)
                            $('.price').html(G.couponsAvailableDefault.addPrice);
                            $('.js-current-coupons i').html(G.couponsAvailableDefault.present)
                            eCacheUtil.storage.cache('addPrice',G.couponsAvailableDefault.present)
                            eCacheUtil.storage.cache('discount_info_infos',G.couponsAvailableDefault.couponCode);
                        }


                        if(G.couponsUsableArr) {
                            $('.js-all-coupons i').text( G.couponsUsableArr.length );
                        }

                    }else{
                        alert(data.resultMessage);
                    }
                });
            }


            function calPrice(obj) {
                var prePrice = parseInt(eCacheUtil.storage.getCache('initPrice'))
                var couponPrice = obj.couponPrice;
                if (obj.couponType == 1) {
                    obj.addPrice = parseInt(prePrice * (couponPrice / 100));
                    if (obj.addPrice >= obj.addPriceUpper) {
                        obj.addPrice = prePrice + parseInt(0)
                        obj.present = parseInt(obj.addPriceUpper);
                    } else {

                        obj.addPrice = prePrice + obj.addPrice;
                        obj.present = parseInt(prePrice * (couponPrice / 100));
                    }

                } else if (obj.couponType == 2) {
                    if (prePrice > obj.subtractionPrice) {
                        obj.addPrice = prePrice + parseInt(obj.couponPrice);
                        obj.present = obj.couponPrice;
                    } else {
                        obj.addPrice = prePrice;
                        obj.present = 0;
                    }



                }
                return obj;
            }

            function isLoginCheck() {
                loginPhone = eCacheUtil.storage.getCache(CacheKey.loginPhone);
                HappyGoMobile = eCacheUtil.storage.getCache(CacheKey.HappyGoMobile);
                if(loginPhone) {
                    initPhone = loginPhone;
                    if(initPhone && initPhone !== 'null') {
                        $('#alipay2').val(initPhone)
                        $("#phoneTip").show()
                        $('#inputtel').val(initPhone)

                        $("#addInfo").show();
                        $("#showLogin").hide();
                    }else {
                        $("#addInfo").hide();
                        $("#showLogin").show();
                    }
                    initPrice ();
                }else if(HappyGoMobile){
                    initPhone = HappyGoMobile;
                    if(initPhone && initPhone !== 'null') {
                        $('#alipay2').val(initPhone)
                        $("#phoneTip").show()
                        $('#inputtel').val(initPhone)

                        $("#addInfo").show();
                        $("#showLogin").hide();
                    }else {
                        $("#addInfo").hide();
                        $("#showLogin").show();
                    }
                    initPrice ();
                }else {
                    $.post(
                        getRealPath()+"/recycle/isLogin.do",
                        {},
                        function(data){
                            if ( data.success){
                                eCacheUtil.storage.cache(CacheKey.loginPhone,data.result.phone);
                                loginPhone = eCacheUtil.storage.getCache(CacheKey.loginPhone);
                                HappyGoMobile = eCacheUtil.storage.getCache(CacheKey.HappyGoMobile);
                                if(loginPhone) {
                                    initPhone = loginPhone;
                                }else if(HappyGoMobile){
                                    initPhone = HappyGoMobile;
                                }
                            }else{
                            }

                            if(initPhone && initPhone !== 'null') {
                                $('#alipay2').val(initPhone)
                                $("#phoneTip").show()
                                $('#inputtel').val(initPhone)

                                $("#addInfo").show();
                                $("#showLogin").hide();
                            }else {
                                $("#addInfo").hide();
                                $("#showLogin").show();
                            }
                            initPrice ();
                        });
                }



            }
            //    弹出登录弹框
            $("#showLogin").on('click',function () {
                $("#popoDialog").removeClass('hide')
            })

            //   关闭弹窗
            $("#closePopoDialogBtn").on('click',function () {
                $("#popoDialog").addClass('hide');
            })

            // 获取验证码
            $("#getCodeBtn").on('click',function () {

                if(!$("#phoneNum").val()) {
                    alertTip('请输入手机号码');
                    return false;
                }else if(!(/^1[123456789]\d{9}$/.test($("#phoneNum").val()))) {
                    alertTip('手机号码不正确，请重新输入');
                    return false;
                }else {
                    var params = {
                        phone: $("#phoneNum").val()
                    }
                    $.post(linkUrl+'/recycle/sendSmsCode.do',{params:JSON.stringify(params)},
                        function(data){
                            Countdown($("#getCodeBtn").get(0),60)
                            if(data.success) {

                            }else {
                                alertTip(data.resultMessage);
                            }
                            // {"success":false,"resultMessage":"系统异常请稍后再试","msg":null,"resultCode":"5","result":null}
                        })//
                }
            })

            // 登录
            $("#doPrizeBtn").on('click',function () {
                if(!$("#phoneNum").val()) {
                    alertTip('请输入手机号码');
                    return false;
                }else if(!(/^1[123456789]\d{9}$/.test($("#phoneNum").val()))) {
                    alertTip('手机号码不正确，请重新输入');
                    return false;
                }else if(!$("#codeNum").val() || !$("#codeNum").val().trim() ){
                    alertTip('请输入验证码');
                    return false;
                }else {
                    var params = {
                        phone: $("#phoneNum").val(),
                        checkCode: $("#codeNum").val()
                    }
                    $.post(linkUrl+'/recycle/checkLogin.do',{params:JSON.stringify(params)},
                        function(data){
                            if(data.success) {
                                eCacheUtil.storage.cache(CacheKey.loginPhone,$("#phoneNum").val())

                                $("#popoDialog").addClass('hide')
                                alertTip('登录成功')
                            }else {
                                alertTip(data.resultMessage);
                            }

                            isLoginCheck();
                            // {"success":false,"resultMessage":"系统异常请稍后再试","msg":null,"resultCode":"5","result":null}
                        })//
                }
            })


            //加价券 跳转到addPriceTicket.html
            $('.js-ticket-btn').on('click',function(){
                if(G.couponsUsableArr != undefined){
                    //如果没有加价券，直接返回
                    if(  G.couponsUsableArr.length > 0 || G.couponsNotUsableArr.length > 0 ){
                        initAddpricePage();
                        $('#add-price-ticket').removeClass( 'hide' );
                    }
                }
                return ;
            })

            function initAddpricePage(){
                // 可用不可用优惠券的数量
                $('.js-available-num').text( G.couponsUsableArr.length )
                $('.js-not-available-num').text( G.couponsNotUsableArr.length )

                // 可用优惠券
                var couponAvailableHTML = ''
                for( var i = 0; i < G.couponsUsableArr.length; i++ ){
                    var classHtml = '';
                    // 判断是否是默认优惠券
                    // G.couponsAvailableDefault = {}
                    if( G.couponsAvailableDefault && G.couponsAvailableDefault.couponCode && G.couponsUsableArr[i].couponCode == G.couponsAvailableDefault.couponCode ){
                        classHtml = '<dd class="ticket-item can-use default" data-code="'+ G.couponsUsableArr[i].couponCode +'">';
                    }else{
                        classHtml = '<dd class="ticket-item can-use" data-code="'+ G.couponsUsableArr[i].couponCode +'">'
                    }
                    if(G.couponsUsableArr[i].couponType == 1) {
                        couponAvailableHTML+=   classHtml+
                            '	<div class="ticket-info">'+
                            '		<div class="ticket-value">'+ G.couponsUsableArr[i].couponPrice +'%</div>'+
                            '		<div class="ticket-desc">'+
                            '			<label>加价券</label>'+
                            '			<span class="condition">'+ G.couponsUsableArr[i].couponName +'</span>'+
                            '		</div>'+
                            '	</div>'+
                            '	<div class="ticket-date">'+
                            '		<label>有效期:</label>'+
                            '		<span class="start-date">'+ G.couponsUsableArr[i].beginTime +'</span>至<span class="end-date">'+ G.couponsUsableArr[i].endTime +'</span>'+
                            '	</div>'+
                            '</dd>'

                    }else if(G.couponsUsableArr[i].couponType == 2){
                        couponAvailableHTML+=   classHtml+
                            '	<div class="ticket-info">'+
                            '		<div class="ticket-value">'+ G.couponsUsableArr[i].couponPrice +'元</div>'+
                            '		<div class="ticket-desc">'+
                            '			<label>加价券</label>'+
                            '			<span class="condition">'+ G.couponsUsableArr[i].couponName +'</span>'+
                            '		</div>'+
                            '	</div>'+
                            '	<div class="ticket-date">'+
                            '		<label>有效期:</label>'+
                            '		<span class="start-date">'+ G.couponsUsableArr[i].beginTime +'</span>至<span class="end-date">'+ G.couponsUsableArr[i].endTime +'</span>'+
                            '	</div>'+
                            '</dd>'

                    }


                }
                $('.js-coupon-available').html( couponAvailableHTML );

                var couponNotAvailableHTML = ''
                for( var i = 0; i < G.couponsNotUsableArr.length; i++ ){
                    if(G.couponsNotUsableArr[i].couponType == 1) {
                        couponNotAvailableHTML+= '<dd class="ticket-item used" data-code="'+ G.couponsNotUsableArr[i].couponCode +'">'+
                            '	<div class="ticket-info">'+
                            '		<div class="ticket-value">'+ G.couponsNotUsableArr[i].couponPrice +'%</div>'+
                            '		<div class="ticket-desc">'+
                            '			<label>加价券</label>'+
                            '			<span class="condition">'+ G.couponsNotUsableArr[i].couponName +'</span>'+
                            '		</div>'+
                            '	</div>'+
                            '	<div class="ticket-date">'+
                            '		<label>有效期:</label>'+
                            '		<span class="start-date">'+ G.couponsNotUsableArr[i].beginTime +'</span>至<span class="end-date">'+ G.couponsNotUsableArr[i].endTime +'</span>'+
                            '	</div>'+
                            '</dd>'

                    }else if(G.couponsNotUsableArr[i].couponType == 2){
                        couponNotAvailableHTML+= '<dd class="ticket-item used" data-code="'+ G.couponsNotUsableArr[i].couponCode +'">'+
                            '	<div class="ticket-info">'+
                            '		<div class="ticket-value">'+ G.couponsNotUsableArr[i].couponPrice +'元</div>'+
                            '		<div class="ticket-desc">'+
                            '			<label>加价券</label>'+
                            '			<span class="condition">'+ G.couponsNotUsableArr[i].couponName +'</span>'+
                            '		</div>'+
                            '	</div>'+
                            '	<div class="ticket-date">'+
                            '		<label>有效期:</label>'+
                            '		<span class="start-date">'+ G.couponsNotUsableArr[i].beginTime +'</span>至<span class="end-date">'+ G.couponsNotUsableArr[i].endTime +'</span>'+
                            '	</div>'+
                            '</dd>'

                    }
                }
                $('.js-coupon-not-available').html( couponNotAvailableHTML );

            }

            //切换优惠券
            $('.js-coupon-available').delegate( '.ticket-item' , 'click' , function(){
                //获取手机的估价
                var MP = eCacheUtil.storage.getCache( CacheKey.prePrice );

                //缓存默认优惠券
                for(var i = 0; i < G.couponsUsableArr.length; i++){
                    if( $(this).data('code') == G.couponsUsableArr[i].couponCode ){
                        //保存默认的优惠券
                        G.couponsAvailableDefault = G.couponsUsableArr[i] ;
                        eCacheUtil.storage.cache('discount_info_infos',G.couponsUsableArr[i].couponCode)
                    }
                }
                var currentDiscount = calPrice(G.couponsAvailableDefault);
                $('.js-current-coupons i').text( currentDiscount.present);
                $(".price").text( currentDiscount.addPrice)
                $("#disTip").html('加价'+ G.couponsAvailableDefault.present + '元' + "（30分钟内下单有效）")
                eCacheUtil.storage.cache('addPrice',G.couponsAvailableDefault.present)

                //刷新页面内容
                // if( G.couponsAvailableDefault.couponPrice.indexOf('%') != -1 ){
                //     if(parseFloat(MP) * parseFloat(G.couponsAvailableDefault.couponPrice) > G.couponsAvailableDefault.upperLimit){
                //         $('.js-current-coupons i').text( G.couponsAvailableDefault.upperLimit );
                //     }else{
                //         $('.js-current-coupons i').text( MP * G.couponsAvailableDefault.couponPrice.replace('%','') / 100 );
                //     }
                // }else {
                //     $('.js-current-coupons i').text( G.couponsAvailableDefault.couponPrice.replace('元','') );
                // }

                //关闭选择框
                $('#add-price-ticket').addClass( 'hide' );
            });

            //初始化优惠券列表
        })

    </script>
<!--站长统计-->
<div style="display: none;">
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1261469862'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1261469862%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
</body>
</html>
